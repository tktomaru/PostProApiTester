# 要求定義文書：PostPro API Tester Chrome 拡張

## 1. はじめに

### 1.1 文書の目的
本要求定義文書は、システム企画書に基づいてPostPro API Tester Chrome拡張機能の具体的な機能要求、非機能要求、制約条件を詳細に定義し、開発チームが実装すべき仕様を明確化することを目的とします。

### 1.2 文書の範囲
- 機能要求の詳細仕様
- 非機能要求の具体的基準
- ユーザーインターフェース要件
- システム間連携要件
- データ要件
- セキュリティ要件

### 1.3 参照文書
- システム企画書（docs/1.sp.md）
- プロジェクト構成ファイル（CLAUDE.md）
- 既存ソースコード（src/）

---

## 2. システム概要

### 2.1 システムの目的
ブラウザ内で完結するAPI開発・テスト支援ツールとして、Postman互換機能を提供し、開発からテスト、共有まで一貫したワークフローを実現する。

### 2.2 システムの位置づけ
- Chrome拡張機能として動作
- 既存のPostmanワークフローとの互換性を持つ
- エコーAPI（https://reply.tukutano.jp）との連携機能
- 単体でのAPI開発・テスト環境を提供

---

## 3. 機能要求

### 3.1 リクエスト管理機能

#### FR-001: HTTPリクエスト送信機能
**要求ID**: FR-001
**優先度**: 必須
**概要**: 各種HTTPメソッドによるAPIリクエストの送信機能

**詳細仕様**:
- **対応HTTPメソッド**: GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS
- **URL入力**: プロトコルを含む完全なURL形式（http://, https://）
- **リクエストタイムアウト**: デフォルト30秒、最大300秒まで設定可能
- **リダイレクト**: 自動追従（最大10回）
- **SSL証明書**: 不正な証明書の警告表示と継続選択

**受入条件**:
- すべてのHTTPメソッドが正常に送信できること
- URLバリデーションが適切に動作すること
- タイムアウト設定が有効に動作すること

#### FR-002: 認証機能
**要求ID**: FR-002
**優先度**: 必須
**概要**: 各種認証方式のサポート

**詳細仕様**:
- **Basic認証**: ユーザー名・パスワード入力、Base64エンコード自動実行
- **Bearer Token**: トークン文字列の入力、Authorizationヘッダー自動設定
- **API Key**: キー名・値・送信場所（Header/Query Parameter）の指定
- **OAuth2**: Authorization Codeフロー、Access Token自動取得（今後実装）

**受入条件**:
- 各認証方式が正しくHTTPヘッダーに設定されること
- 認証情報が適切に暗号化保存されること
- 認証失敗時の適切なエラーメッセージ表示

#### FR-003: リクエストボディ管理
**要求ID**: FR-003
**優先度**: 必須
**概要**: 多様なデータ形式でのリクエストボディ作成機能

**詳細仕様**:
- **JSON**: シンタックスハイライト、フォーマット機能、バリデーション
- **Form Data**: key-value形式、ファイルアップロード対応
- **Raw Text**: プレーンテキスト、XML、HTML等
- **Binary**: ファイル選択、サイズ制限（10MB）

**受入条件**:
- JSONバリデーションが適切に動作すること
- ファイルアップロードが正常に動作すること
- Content-Typeヘッダーが自動設定されること

#### FR-004: ヘッダー・パラメータ管理
**要求ID**: FR-004
**優先度**: 必須
**概要**: HTTPヘッダーとクエリパラメータの動的管理

**詳細仕様**:
- **動的追加・削除**: key-value形式でのヘッダー・パラメータ管理
- **プリセット機能**: よく使用するヘッダーのテンプレート
- **自動補完**: 一般的なヘッダー名の候補表示
- **有効/無効切り替え**: チェックボックスによる個別制御

**受入条件**:
- ヘッダーとパラメータが正しく送信されること
- 変数置換が適切に動作すること
- プリセット機能が正常に動作すること

### 3.2 スクリプト実行機能

#### FR-005: Pre-requestスクリプト実行
**要求ID**: FR-005
**優先度**: 必須
**概要**: リクエスト送信前のJavaScript実行機能

**詳細仕様**:
- **JavaScript実行環境**: サンドボックス化されたV8エンジン
- **変数操作**: グローバル・環境・コレクション変数の読み書き
- **動的データ生成**: タイムスタンプ、UUID、ランダム値生成
- **外部API呼び出し**: XMLHttpRequestによる事前API実行
- **実行時間制限**: 10秒タイムアウト

**受入条件**:
- Pre-requestスクリプトが正常に実行されること
- 変数への値設定が後続処理に反映されること
- エラー時の適切なメッセージ表示

#### FR-006: テストスクリプト実行
**要求ID**: FR-006
**優先度**: 必須
**概要**: レスポンス受信後のテスト自動実行機能

**詳細仕様**:
- **Postman互換API**: pm.test(), pm.expect(), pm.response等
- **従来形式コマンド**: status, headerEquals, bodyContains等
- **JSONPath検証**: 複雑なJSON構造からのデータ抽出・検証
- **アサーション**: 詳細なテスト結果表示（成功/失敗/エラー）
- **結果レポート**: テスト実行結果の保存・表示

**受入条件**:
- Postman互換APIが正常に動作すること
- テスト結果が適切に表示されること
- 失敗時の詳細な原因表示

### 3.3 変数管理機能

#### FR-007: 変数システム
**要求ID**: FR-007
**優先度**: 必須
**概要**: 3階層の変数管理システム

**詳細仕様**:
- **グローバル変数**: 全体で共有される変数
- **環境変数**: 環境（開発・本番等）固有の変数
- **コレクション変数**: 特定コレクション内での変数
- **優先順位**: コレクション > 環境 > グローバル
- **変数置換**: {{variableName}}形式での動的置換
- **変数スコープ**: 実行コンテキストでの適切な変数解決

**受入条件**:
- 変数の優先順位が正しく適用されること
- 変数置換が全ての入力フィールドで動作すること
- 循環参照の検出と防止

#### FR-008: 実行時変数設定
**要求ID**: FR-008
**優先度**: 必須
**概要**: スクリプト実行時の動的変数設定

**詳細仕様**:
- **レスポンス値の変数化**: JSON path指定による値抽出
- **計算結果の変数化**: スクリプト内での計算結果保存
- **セッション変数**: 一時的な値の保持
- **変数の永続化**: ローカルストレージへの自動保存

**受入条件**:
- レスポンス値が正しく変数に設定されること
- 次回リクエストで設定値が利用できること
- 変数の永続化が正常に動作すること

### 3.4 データ管理機能

#### FR-009: コレクション管理
**要求ID**: FR-009
**優先度**: 必須
**概要**: 関連するリクエストのグループ化管理

**詳細仕様**:
- **階層構造**: フォルダによる階層的な整理
- **コレクション作成**: 名前・説明・変数の設定
- **リクエスト追加**: 既存リクエストの追加・移動
- **コレクション実行**: 全リクエストの一括実行
- **共有機能**: エクスポート・インポート

**受入条件**:
- コレクションの作成・編集・削除が正常に動作すること
- リクエストの追加・移動が適切に実行されること
- 一括実行が順序通りに実行されること

#### FR-010: シナリオ実行
**要求ID**: FR-010
**優先度**: 必須
**概要**: 複数リクエストの順次実行ワークフロー

**詳細仕様**:
- **実行順序**: リクエストの順序指定
- **条件分岐**: テスト結果による実行制御
- **エラーハンドリング**: 失敗時の停止・継続選択
- **進捗表示**: 実行状況のリアルタイム表示
- **実行レポート**: 全体の実行結果サマリー

**受入条件**:
- シナリオが指定順序で実行されること
- エラー時の制御が適切に動作すること
- 実行結果が詳細に記録されること

#### FR-011: 履歴管理
**要求ID**: FR-011
**優先度**: 必須
**概要**: リクエスト実行履歴の自動保存・管理

**詳細仕様**:
- **自動保存**: 実行したリクエストの自動記録
- **履歴検索**: URL、メソッド、日時での検索
- **履歴再実行**: 過去のリクエストの再実行
- **履歴削除**: 個別・一括削除機能
- **保存期間**: 最大1000件、90日間保持

**受入条件**:
- リクエスト実行が自動で履歴に保存されること
- 検索機能が適切に動作すること
- 履歴からの再実行が正常に動作すること

### 3.5 インポート・エクスポート機能

#### FR-012: データ交換機能
**要求ID**: FR-012
**優先度**: 必須
**概要**: 設定データの共有・バックアップ機能

**詳細仕様**:
- **エクスポート形式**: JSON形式（独自形式）
- **エクスポート対象**: コレクション、環境変数、設定
- **インポート機能**: ファイル選択・ドラッグ&ドロップ
- **データ検証**: インポート時の形式チェック
- **競合解決**: 既存データとの統合オプション

**受入条件**:
- エクスポートしたデータが正しく復元できること
- 不正なファイルが適切に拒否されること
- データの整合性が保たれること

### 3.6 テスト・検証機能

#### FR-013: レスポンス検証
**要求ID**: FR-013
**優先度**: 必須
**概要**: APIレスポンスの自動検証機能

**詳細仕様**:
- **ステータスコード検証**: 期待値との比較
- **ヘッダー検証**: 特定ヘッダーの存在・値チェック
- **ボディ検証**: JSON構造・値の検証
- **レスポンス時間**: 性能チェック（しきい値設定）
- **サイズ検証**: レスポンスサイズのチェック

**受入条件**:
- 各検証項目が正確に判定されること
- 検証結果が分かりやすく表示されること
- カスタム検証ルールが設定できること

#### FR-014: エコーAPIテスト
**要求ID**: FR-014
**優先度**: 必須
**概要**: 専用エコーAPIとの連携テスト機能

**詳細仕様**:
- **エコーAPI**: https://reply.tukutano.jp
- **送信内容確認**: リクエストメソッド、URL、ヘッダー、ボディ
- **専用コマンド**: echoRequestMethodEquals, echoRequestHeaderEquals等
- **フォールバック**: エコーAPI利用不可時の代替機能
- **結果比較**: 送信データと受信データの比較表示

**受入条件**:
- エコーAPIとの通信が正常に動作すること
- 専用コマンドが適切に検証を実行すること
- フォールバック機能が適切に動作すること

---

## 4. 非機能要求

### 4.1 性能要求

#### NFR-001: レスポンス性能
- **アプリケーション起動時間**: 200ms以下
- **リクエスト実行時間**: 送信から結果表示まで1秒以内（ネットワーク時間除く）
- **UI操作レスポンス**: ユーザー操作から画面更新まで100ms以内
- **大量データ処理**: 1MBまでのレスポンスを5秒以内で表示

#### NFR-002: リソース使用量
- **メモリ使用量**: 50MB以下（Chrome拡張機能として）
- **ストレージ使用量**: 最大100MBまでのローカルストレージ使用
- **CPU使用率**: アイドル時5%以下、処理時50%以下

### 4.2 可用性要求

#### NFR-003: 稼働率
- **拡張機能の稼働率**: 99.9%以上
- **エラー復旧時間**: 自動復旧機能による即座の復旧
- **データ整合性**: ローカルストレージ破損時の自動修復

#### NFR-004: 障害対応
- **エラーハンドリング**: 全ての例外状況での適切なエラー表示
- **ログ記録**: デバッグ用の詳細ログ出力
- **バックアップ**: 設定データの自動バックアップ機能

### 4.3 セキュリティ要求

#### NFR-005: データ保護
- **認証情報の暗号化**: AES-256による認証情報の暗号化
- **ローカルストレージ**: 機密データの暗号化保存
- **メモリ保護**: 認証情報の適切なメモリクリア

#### NFR-006: スクリプト実行セキュリティ
- **サンドボックス実行**: V8サンドボックス環境での安全な実行
- **API制限**: 危険なAPI（eval, Function等）の無効化
- **実行時間制限**: 無限ループ防止のタイムアウト設定

### 4.4 互換性要求

#### NFR-007: ブラウザ互換性
- **対応ブラウザ**: Chrome 100以降（主要対象）
- **拡張機能仕様**: Manifest V3対応
- **API互換性**: Chrome Extensions API V3準拠

#### NFR-008: データ互換性
- **Postman互換**: 基本的なPostmanコレクション構造との互換性
- **後方互換性**: アップデート時の既存データ保持

### 4.5 保守性要求

#### NFR-009: コード品質
- **テストカバレッジ**: 80%以上の単体テストカバレッジ
- **型安全性**: TypeScript厳密モードによる型チェック
- **コードレビュー**: 全ての変更に対するレビュー実施

#### NFR-010: 拡張性
- **モジュラー設計**: 機能の独立性とプラグイン対応準備
- **API設計**: 将来の機能拡張を考慮したインターフェース設計
- **国際化対応**: 多言語対応の基盤整備

---

## 5. ユーザーインターフェース要求

### 5.1 UI設計要求

#### UIR-001: レスポンシブデザイン
- **画面サイズ対応**: 最小800x600から最大1920x1080まで対応
- **レイアウト**: タブベースの画面構成
- **操作性**: マウス・キーボード操作の最適化

#### UIR-002: アクセシビリティ
- **キーボード操作**: 全機能のキーボードアクセス対応
- **カラーコントラスト**: WCAG 2.1 AA基準準拠
- **スクリーンリーダー**: aria-label等による適切な情報提供

### 5.2 操作性要求

#### UIR-003: ユーザビリティ
- **直感的操作**: 初回利用者が30分以内に基本操作を習得
- **エラー防止**: 重要操作での確認ダイアログ表示
- **ヘルプ機能**: コンテキストヘルプとツールチップ

#### UIR-004: 表示要求
- **リアルタイム更新**: 処理状況のリアルタイム表示
- **結果表示**: レスポンスデータの構造化表示
- **エラー表示**: 分かりやすいエラーメッセージ

---

## 6. システム間連携要求

### 6.1 Chrome拡張機能連携

#### SIR-001: バックグラウンド処理
- **Service Worker**: Manifest V3のService Worker対応
- **権限管理**: 最小権限での動作
- **ライフサイクル**: 拡張機能の適切な開始・終了処理

#### SIR-002: ブラウザ統合
- **コンテンツスクリプト**: Webページとの統合機能
- **タブ管理**: アクティブタブでの動作
- **ストレージ**: Chrome Storage APIの活用

### 6.2 外部API連携

#### SIR-003: エコーAPI連携
- **API仕様**: https://reply.tukutano.jp仕様準拠
- **エラーハンドリング**: API利用不可時の適切な処理
- **レート制限**: API制限に対する適切な制御

#### SIR-004: 将来的な外部連携
- **プラグインAPI**: 第三者による機能拡張API準備
- **CI/CD連携**: Jenkins/GitHub Actions連携準備
- **クラウド同期**: 将来的なクラウド連携基盤

---

## 7. データ要求

### 7.1 データ構造要求

#### DR-001: ローカルストレージ構造
```json
{
  "collections": [
    {
      "id": "string",
      "name": "string",
      "description": "string",
      "variables": {},
      "requests": []
    }
  ],
  "environments": [
    {
      "id": "string",
      "name": "string",
      "variables": {}
    }
  ],
  "globalVariables": {},
  "settings": {},
  "history": []
}
```

#### DR-002: リクエストデータ構造
```json
{
  "id": "string",
  "name": "string",
  "method": "GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS",
  "url": "string",
  "headers": {},
  "params": {},
  "body": {
    "mode": "json|form|raw|binary",
    "data": "any"
  },
  "auth": {
    "type": "none|basic|bearer|apikey|oauth2",
    "config": {}
  },
  "preRequestScript": "string",
  "testScript": "string"
}
```

### 7.2 データ管理要求

#### DR-003: データ永続化
- **自動保存**: 操作後の即座な保存
- **データ検証**: 保存データの整合性チェック
- **バックアップ**: 自動バックアップ機能
- **復旧**: データ破損時の自動復旧

#### DR-004: データ移行
- **バージョン管理**: データ構造のバージョン管理
- **マイグレーション**: 旧バージョンからの自動移行
- **互換性**: 後方互換性の保持

---

## 8. 制約条件

### 8.1 技術的制約

#### CON-001: Chrome拡張機能制約
- **Manifest V3**: 新しいマニフェスト仕様への準拠
- **CSP制約**: Content Security Policyによる制限
- **権限制約**: 最小権限での動作要求

#### CON-002: ブラウザ制約
- **CORS制約**: Cross-Origin制約の適切な処理
- **ストレージ制限**: ローカルストレージの容量制限
- **実行時間制限**: 長時間処理の制限

### 8.2 運用制約

#### CON-003: 依存関係
- **エコーAPI依存**: 外部APIサービスへの依存
- **Chrome更新**: ブラウザ更新による影響
- **ライブラリ依存**: 使用ライブラリのメンテナンス状況

#### CON-004: サポート制約
- **対象ユーザー**: 開発者・テストエンジニア
- **サポート言語**: 日本語・英語
- **サポート範囲**: 基本機能とドキュメント提供

---

## 9. 受入条件

### 9.1 機能受入条件

1. **リクエスト送信**: 全HTTPメソッドでのリクエスト送信が正常に動作すること
2. **認証機能**: 4種類の認証方式が適切に動作すること
3. **スクリプト実行**: Pre-requestとテストスクリプトが正常に実行されること
4. **変数管理**: 3階層の変数システムが適切に動作すること
5. **データ管理**: コレクション・シナリオ・履歴管理が正常に動作すること
6. **テスト機能**: レスポンス検証とエコーAPIテストが正常に動作すること

### 9.2 非機能受入条件

1. **性能**: 指定された性能基準を満たすこと
2. **セキュリティ**: セキュリティ要求を満たすこと
3. **可用性**: 障害時の適切な復旧機能を持つこと
4. **保守性**: テストカバレッジ80%以上を達成すること

### 9.3 品質受入条件

1. **テスト実行**: 全ての単体テストが成功すること
2. **統合テスト**: Puppeteer統合テストが成功すること
3. **ビルドテスト**: Chrome拡張機能として正常に動作すること
4. **ユーザビリティ**: 基本操作を30分以内で習得可能なこと

---

## 10. 変更管理

### 10.1 要求変更プロセス
1. **変更要求**: 利害関係者からの要求変更申請
2. **影響分析**: 変更による影響範囲の分析
3. **承認プロセス**: プロジェクトマネージャーによる承認
4. **文書更新**: 要求定義文書の更新
5. **実装反映**: 開発チームでの実装

### 10.2 優先度管理
- **必須**: システムの基本動作に必要な要求
- **重要**: ユーザビリティ向上に寄与する要求
- **任意**: 将来的な拡張を見据えた要求

---

## 11. 用語集

| 用語 | 定義 |
|------|------|
| Chrome拡張機能 | Google Chromeブラウザに追加機能を提供するプログラム |
| Manifest V3 | Chrome拡張機能の新しい仕様バージョン |
| Pre-requestスクリプト | HTTPリクエスト送信前に実行されるJavaScriptコード |
| テストスクリプト | HTTPレスポンス受信後に実行される検証用JavaScriptコード |
| エコーAPI | 送信されたリクエスト内容をそのまま返すAPI（https://reply.tukutano.jp） |
| JSONPath | JSON構造からデータを抽出するためのクエリ言語 |
| サンドボックス | セキュリティのための隔離された実行環境 |
| CORS | Cross-Origin Resource Sharing（オリジン間リソース共有） |

---

## 12. 付録

### 12.1 参考資料
- Chrome Extensions API Documentation
- Postman API Documentation
- JSONPath Specification
- Web Content Accessibility Guidelines (WCAG) 2.1

### 12.2 更新履歴
| 日付 | バージョン | 更新内容 | 更新者 |
|------|-----------|----------|--------|
| 2025-01-10 | 1.0 | 初版作成 | Claude Code |

---

**この要求定義文書は、PostPro API Tester Chrome拡張機能の開発において、開発チームが実装すべき詳細な仕様を定義したものです。システム企画書と合わせて、プロジェクトの成功に向けた指針として活用してください。**