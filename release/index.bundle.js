const ot={apiUrl:{value:"https://reply.tukutano.jp",description:"基本となる API の URL"},baseUrl:{value:"https://reply.tukutano.jp",description:"基本となる API の URL"},timeout:{value:"30000",description:"タイムアウト（ミリ秒）"}},rt=[{id:"env_dev",name:"Development",created:new Date().toISOString(),variables:{}},{id:"env_prod",name:"Production",created:new Date().toISOString(),variables:{}}],Vt={env_dev:{devToken:{value:"dev-abcdef12345",description:"開発用トークン"}},env_prod:{prodToken:{value:"prod-xyz987654",description:"本番用トークン"}}},Jt=[{id:"col_sample",name:"Sample Collection",description:"サンプル用コレクション",requests:[{id:"req1",name:"POST Users",method:"POST",url:"{{apiUrl}}/api/auth/login",headers:{Accept:"application/json",removeHeader:"removeHeaderValue"},params:{page:"1"},body:JSON.stringify({username:"tomaru",password:""}),auth:{type:"bearer",token:"{{devToken}}"},folder:"",description:"ユーザー一覧を取得する",bodyType:"none",preRequestScript:`
// リクエスト/レスポンス実行結果の参照例
// リクエストのヘッダーを参照
addHeaderWithVar Authorization \${"collections"."Sample Collection"."POST Users"."request"."headers"."authorization"}

// レスポンスのステータスコードを参照
setVarFromHeader statusCode \${"collections"."Sample Collection"."POST Users"."response"."status"}

// レスポンスのボディから値を取得
setBodyWithVar \${"collections"."Sample Collection"."POST Users"."response"."body"."token"}

// 既存のプリリクエストスクリプト
setUrl https://reply.tukutano.jp/items?page=9
addHeader test scriptadd
removeHeader removeHeader
setBody setBodyWithScript
//setUrlWithVar apiBaseUrl
//addHeaderWithVar Authorization authtoken
//setBodyWithVar requestPayload
  `},{id:"req_sample_post_1",name:"サンプル POST 1",method:"POST",url:"https://reply.tukutano.jp/items?page=1",headers:{"Content-Type":"application/json",Cookie:"sessionId=abc123def456; userId=12345; theme=dark; language=ja"},params:{},body:"test body text",auth:{type:"none"},bodyType:"raw",preRequestScript:`
// リクエスト/レスポンス実行結果の参照例
// 前のリクエストのレスポンスから値を取得して使用

// 既存のプリリクエストスクリプト
setUrl https://reply.tukutano.jp/items?page=9
addHeader test scriptadd
addHeader authorization scriptadd-authorization11
removeHeader removeHeader
setBody setBodyWithScript2
//setUrlWithVar apiBaseUrl
//addHeaderWithVar Authorization authtoken
//setBodyWithVar requestPayload
  `},{id:"req_sample_post_2",name:"サンプル POST 2",method:"POST",url:"https://reply.tukutano.jp/items?page=2",headers:{"Content-Type":"application/json",Cookie:'authToken=xyz789ghi012; csrfToken=csrf_abc123; preferences={"notifications":true}'},params:{},body:"test body text",auth:{type:"none"},bodyType:"raw",preRequestScript:`
// リクエスト/レスポンス実行結果の参照例
// 前のリクエストのレスポンスから値を取得して使用
addHeaderWithVar Authorization \${"collections"."Sample Collection"."サンプル POST 1"."response"."headers"."authorization"}
setBodyWithVar \${"collections"."Sample Collection"."サンプル POST 1"."response"."body".jsonPath("$.headers.authorization")}

// 既存のプリリクエストスクリプト
setUrl https://reply.tukutano.jp/items?page=9
addHeader test scriptadd
removeHeader removeHeader
//setBody setBodyWithScript2
//setUrlWithVar apiBaseUrl
//addHeaderWithVar Authorization authtoken
//setBodyWithVar requestPayload
  `}]},{id:"col_integration_tests",name:"Integration Tests (Echo API)",description:"reply.tukutano.jpを使用した結合テスト用コレクション",requests:[{id:"req_echo_get",name:"GET Echo Test",method:"GET",url:"https://reply.tukutano.jp/api/users",headers:{Accept:"application/json","X-Test-Header":"test-value","User-Agent":"API-Tester"},params:{page:"1",limit:"10"},body:null,auth:{type:"none"},bodyType:"none",preRequestScript:"",testScript:`// Postman形式のテストスクリプト例
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

pm.test("Response contains request echo", function () {
    const responseJson = pm.response.json();
    pm.expect(responseJson.method).to.equal("GET");
    pm.expect(responseJson.url).to.include("/api/users");
});

pm.test("Headers are echoed correctly", function () {
    const responseJson = pm.response.json();
    pm.expect(responseJson.headers['accept']).to.equal('application/json');
    pm.expect(responseJson.headers['x-test-header']).to.equal('test-value');
});

pm.test("Query parameters are included", function () {
    const responseJson = pm.response.json();
    pm.expect(responseJson.url).to.include("page=1");
    pm.expect(responseJson.url).to.include("limit=10");
});`},{id:"req_echo_post",name:"POST Echo Test",method:"POST",url:"https://reply.tukutano.jp/api/auth/login",headers:{"Content-Type":"application/json",Accept:"application/json","X-API-Key":"test-api-key",Cookie:"loginSession=sess_abc123xyz; rememberMe=true; lastActivity=1640995200"},params:{},body:JSON.stringify({username:"testuser",password:"testpass123",remember:!0}),auth:{type:"none"},bodyType:"json",preRequestScript:"",testScript:`// POSTリクエストのPostman形式テスト
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

pm.test("Request method and URL are correct", function () {
    const responseJson = pm.response.json();
    pm.expect(responseJson.method).to.equal("POST");
    pm.expect(responseJson.url).to.include("/api/auth/login");
});

pm.test("Request headers are correct", function () {
    const responseJson = pm.response.json();
    pm.expect(responseJson.headers['content-type']).to.equal('application/json');
    pm.expect(responseJson.headers['x-api-key']).to.equal('test-api-key');
});

pm.test("Request body is correct", function () {
    const responseJson = pm.response.json();
    const requestBody = JSON.parse(responseJson.body);
    pm.expect(requestBody.username).to.equal("testuser");
    pm.expect(requestBody.password).to.equal("testpass123");
    pm.expect(requestBody.remember).to.be.true;
});

pm.test("Save auth token for next request", function () {
    // エコーAPIのため実際のトークンは返されないが、テスト例として
    pm.environment.set("authToken", "mock-token-from-login");
});`},{id:"req_echo_auth_test",name:"Bearer Auth Echo Test",method:"PUT",url:"https://reply.tukutano.jp/api/users/123",headers:{"Content-Type":"application/json",Accept:"application/json",Cookie:"userToken=bearer_token_sample; sessionTimeout=3600; secureFlag=true"},params:{},body:JSON.stringify({name:"Updated User",email:"updated@example.com"}),auth:{type:"bearer",token:"test-bearer-token-12345"},bodyType:"json",preRequestScript:"",testScript:`// Bearer認証付きリクエストの結合テスト
status 200
echoRequestMethodEquals PUT
echoRequestHeaderEquals Authorization Bearer test-bearer-token-12345
echoRequestHeaderEquals Content-Type application/json
echoRequestHeaderContains cookie userToken=bearer_token_sample; sessionTimeout=3600; secureFlag=true
echoRequestBodyEquals {"name":"Updated User","email":"updated@example.com"}
echoRequestUrlContains /api/users/123`}]}],zt={col_sample:{basePath:{value:"/v1",description:"エンドポイントのバージョン"},userId:{value:"123",description:"サンプルユーザーID"}}},Ut=`
// ステータスコードが 200 かをチェック
//status 200
// Authorization ヘッダーの値を取得して、環境変数 authToken に保存
//setVarFromHeader authToken Authorization
// ボディの JSON に users プロパティがあるかをチェック
// jsonHasProperty users
// jsonArrayLengthEquals users 5
// jsonValueEquals data.id 1234
// bodyContains success
// headerExists Content - Type
                `,Wt=[{id:"scenario_sample_post_flow",name:"Sample post Flow",requests:[{id:"req_sample_POST1",name:"サンプル POST",method:"POST",url:"https://reply.tukutano.jp/items?page=1",headers:{dummyHeader:"dummyHeaderValue"},params:{},body:"defaultBodyValue",auth:{type:"bearer",token:"dummyToken"},bodyType:"raw",preRequestScript:`
addHeader test scriptadd1
setBody setBodyWithScript1
                `,testScript:`
bodyJsonPathEquals $.body setBodyWithScript1
                `},{id:"req_sample_POST2",name:"サンプル POST",method:"POST",url:"https://reply.tukutano.jp/items?page=2",headers:{dummyBody:'${"scenarios"."Sample post Flow"."サンプル POST"."response"."body".jsonPath("$.body")}'},params:{dummyBody:'${"scenarios"."Sample post Flow"."サンプル POST"."response"."body".jsonPath("$.body")}'},body:'{"jsonKey" : "${"scenarios"."Sample post Flow"."サンプル POST"."response"."body".jsonPath("$.headers.authorization")} "}',auth:{type:"none"},bodyType:"json",preRequestScript:`
addHeader test scriptadd2
addHeaderWithVar authorization \${"scenarios"."Sample post Flow"."サンプル POST"."response"."headers"."test"}
//setBodyWithVar \${"scenarios"."Sample post Flow"."サンプル POST"."response"."body".jsonPath("$.headers.authorization")}
                `},{id:"req_sample_POST3",name:"サンプル POST",method:"POST",url:"https://reply.tukutano.jp/items?page=3",headers:{},params:{},body:'{"jsonKey" : "jsonValue"}',auth:{type:"none"},bodyType:"raw",preRequestScript:`
addHeader test scriptadd3
setBody setBodyWithScript3
                `}]},{id:"scenario_sample_get_flow2",name:"Sample get Flow",requests:[{id:"req_sample_get2_1",name:"サンプル GET",method:"GET",url:"https://reply.tukutano.jp/items?page=10",headers:{},params:{},body:"1",auth:{type:"none"},bodyType:"raw",preRequestScript:`
addHeader test scriptadd1
// bodyをセットしてもGETリクエストのため送信されない事に注意する
setBody setBodyWithScript1
                `},{id:"req_sample_get2_2",name:"サンプル GET",method:"GET",url:"https://reply.tukutano.jp/items?page=11",headers:{},params:{},body:'{"jsonKey" : "jsonValue"}',auth:{type:"none"},bodyType:"json",preRequestScript:`
// key＝test、value=scriptadd2
addHeader test scriptadd2
                `},{id:"req_sample_get2_3",name:"サンプル GET",method:"GET",url:"https://reply.tukutano.jp/items?page=12",headers:{},params:{},body:null,auth:{type:"none"},bodyType:"raw",preRequestScript:`
addHeader test scriptadd2
// bodyをセットしてもGETリクエストのため送信されない事に注意する
setBody setBodyWithScript3
                `}]},{id:"scenario_integration_tests",name:"Integration Test Flow (Echo API)",requests:[{id:"req_scenario_echo_auth",name:"Authentication Test",method:"POST",url:"https://reply.tukutano.jp/api/auth/login",headers:{"Content-Type":"application/json",Accept:"application/json",Cookie:"deviceId=dev123abc; trackingConsent=accepted; locale=ja-JP"},params:{},body:JSON.stringify({username:"testuser",password:"secret123"}),auth:{type:"none"},bodyType:"json",preRequestScript:`// 認証リクエストの前処理
addHeader X-Request-Source integration-test`,testScript:`// 認証リクエストの検証
status 200
echoRequestMethodEquals POST
echoRequestHeaderEquals Content-Type application/json
echoRequestHeaderEquals X-Request-Source integration-test
echoRequestHeaderContains cookie deviceId=dev123abc; trackingConsent=accepted; locale=ja-JP
echoRequestBodyEquals {"username":"testuser","password":"secret123"}
echoRequestUrlContains /api/auth/login`},{id:"req_scenario_echo_data",name:"Data Retrieval Test",method:"GET",url:"https://reply.tukutano.jp/api/users/profile",headers:{Accept:"application/json","X-Test-Flow":"integration"},params:{include:"details",format:"json"},body:null,auth:{type:"bearer",token:"mock-auth-token-from-previous-step"},bodyType:"none",preRequestScript:`// 前のステップの結果を利用（模擬）
// 実際のAPIでは前のレスポンスからトークンを取得
addHeader X-Previous-Step completed`,testScript:`// データ取得リクエストの検証
status 200
echoRequestMethodEquals GET
echoRequestHeaderEquals Authorization Bearer mock-auth-token-from-previous-step
echoRequestHeaderEquals X-Test-Flow integration
echoRequestHeaderEquals X-Previous-Step completed
echoRequestUrlContains /api/users/profile
echoRequestUrlContains include=details
echoRequestUrlContains format=json`},{id:"req_scenario_echo_update",name:"Data Update Test",method:"PUT",url:"https://reply.tukutano.jp/api/users/profile",headers:{"Content-Type":"application/json",Accept:"application/json","X-Test-Flow":"integration",Cookie:"updateSession=upd789xyz; editMode=true; lastEdit=1640995800"},params:{},body:JSON.stringify({name:"Updated Test User",email:"updated@test.com",preferences:{theme:"dark",notifications:!0}}),auth:{type:"bearer",token:"mock-auth-token-from-previous-step"},bodyType:"json",preRequestScript:`// 更新リクエストの前処理
addHeader X-Update-Source integration-flow`,testScript:`// データ更新リクエストの検証
status 200
echoRequestMethodEquals PUT
echoRequestHeaderEquals Authorization Bearer mock-auth-token-from-previous-step
echoRequestHeaderEquals Content-Type application/json
echoRequestHeaderEquals X-Test-Flow integration
echoRequestHeaderEquals X-Update-Source integration-flow
echoRequestHeaderContains cookie updateSession=upd789xyz; editMode=true; lastEdit=1640995800
echoRequestBodyEquals {"name":"Updated Test User","email":"updated@test.com","preferences":{"theme":"dark","notifications":true}}
echoRequestUrlContains /api/users/profile`}]}],Kt="modulepreload",Gt=function(e){return"/"+e},st={},ie=function(t,n,o){let r=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),i=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));r=Promise.allSettled(n.map(l=>{if(l=Gt(l),l in st)return;st[l]=!0;const d=l.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const y=document.createElement("link");if(y.rel=d?"stylesheet":Kt,d||(y.as="script"),y.crossOrigin="",y.href=l,i&&y.setAttribute("nonce",i),document.head.appendChild(y),d)return new Promise((m,p)=>{y.addEventListener("load",m),y.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return r.then(a=>{for(const i of a||[])i.status==="rejected"&&s(i.reason);return t().catch(s)})};function Xt(e,t,n){return t=fe(t),on(e,Me()?Reflect.construct(t,n||[],fe(e).constructor):t.apply(e,n))}function dt(e,t,n){if(Me())return Reflect.construct.apply(null,arguments);var o=[null];o.push.apply(o,t);var r=new(e.bind.apply(e,o));return n&&he(r,n.prototype),r}function Me(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Me=function(){return!!e})()}function Yt(e,t){if(typeof e!="object"||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var o=n.call(e,t);if(typeof o!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function Qt(e){var t=Yt(e,"string");return typeof t=="symbol"?t:String(t)}function M(e){"@babel/helpers - typeof";return M=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},M(e)}function pt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Zt(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,Qt(o.key),o)}}function yt(e,t,n){return t&&Zt(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function en(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&he(e,t)}function fe(e){return fe=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(n){return n.__proto__||Object.getPrototypeOf(n)},fe(e)}function he(e,t){return he=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,r){return o.__proto__=r,o},he(e,t)}function tn(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function Oe(e){var t=typeof Map=="function"?new Map:void 0;return Oe=function(o){if(o===null||!tn(o))return o;if(typeof o!="function")throw new TypeError("Super expression must either be null or a function");if(typeof t<"u"){if(t.has(o))return t.get(o);t.set(o,r)}function r(){return dt(o,arguments,fe(this).constructor)}return r.prototype=Object.create(o.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),he(r,o)},Oe(e)}function nn(e){if(e===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function on(e,t){if(t&&(typeof t=="object"||typeof t=="function"))return t;if(t!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return nn(e)}function rn(e){return sn(e)||an(e)||mt(e)||cn()}function sn(e){if(Array.isArray(e))return Pe(e)}function an(e){if(typeof Symbol<"u"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function mt(e,t){if(e){if(typeof e=="string")return Pe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor&&(n=e.constructor.name),n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Pe(e,t)}}function Pe(e,t){(t==null||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function cn(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ln(e,t){var n=typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=mt(e))||t){n&&(e=n);var o=0,r=function(){};return{s:r,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,a=!1,i;return{s:function(){n=n.call(e)},n:function(){var l=n.next();return s=l.done,l},e:function(l){a=!0,i=l},f:function(){try{!s&&n.return!=null&&n.return()}finally{if(a)throw i}}}}var D=Object.prototype.hasOwnProperty;function W(e,t){return e=e.slice(),e.push(t),e}function Ae(e,t){return t=t.slice(),t.unshift(e),t}var un=function(e){en(t,e);function t(n){var o;return pt(this,t),o=Xt(this,t,['JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)']),o.avoidNew=!0,o.value=n,o.name="NewError",o}return yt(t)}(Oe(Error));function S(e,t,n,o,r){if(!(this instanceof S))try{return new S(e,t,n,o,r)}catch(l){if(!l.avoidNew)throw l;return l.value}typeof e=="string"&&(r=o,o=n,n=t,t=e,e=null);var s=e&&M(e)==="object";if(e=e||{},this.json=e.json||n,this.path=e.path||t,this.resultType=e.resultType||"value",this.flatten=e.flatten||!1,this.wrap=D.call(e,"wrap")?e.wrap:!0,this.sandbox=e.sandbox||{},this.preventEval=e.preventEval||!1,this.parent=e.parent||null,this.parentProperty=e.parentProperty||null,this.callback=e.callback||o||null,this.otherTypeCallback=e.otherTypeCallback||r||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},e.autostart!==!1){var a={path:s?e.path:t};s?"json"in e&&(a.json=e.json):a.json=n;var i=this.evaluate(a);if(!i||M(i)!=="object")throw new un(i);return i}}S.prototype.evaluate=function(e,t,n,o){var r=this,s=this.parent,a=this.parentProperty,i=this.flatten,l=this.wrap;if(this.currResultType=this.resultType,this.currPreventEval=this.preventEval,this.currSandbox=this.sandbox,n=n||this.callback,this.currOtherTypeCallback=o||this.otherTypeCallback,t=t||this.json,e=e||this.path,e&&M(e)==="object"&&!Array.isArray(e)){if(!e.path&&e.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!D.call(e,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');var d=e;t=d.json,i=D.call(e,"flatten")?e.flatten:i,this.currResultType=D.call(e,"resultType")?e.resultType:this.currResultType,this.currSandbox=D.call(e,"sandbox")?e.sandbox:this.currSandbox,l=D.call(e,"wrap")?e.wrap:l,this.currPreventEval=D.call(e,"preventEval")?e.preventEval:this.currPreventEval,n=D.call(e,"callback")?e.callback:n,this.currOtherTypeCallback=D.call(e,"otherTypeCallback")?e.otherTypeCallback:this.currOtherTypeCallback,s=D.call(e,"parent")?e.parent:s,a=D.call(e,"parentProperty")?e.parentProperty:a,e=e.path}if(s=s||null,a=a||null,Array.isArray(e)&&(e=S.toPathString(e)),!(!e&&e!==""||!t)){var u=S.toPathArray(e);u[0]==="$"&&u.length>1&&u.shift(),this._hasParentSelector=null;var y=this._trace(u,t,["$"],s,a,n).filter(function(m){return m&&!m.isParentSelector});return y.length?!l&&y.length===1&&!y[0].hasArrExpr?this._getPreferredOutput(y[0]):y.reduce(function(m,p){var f=r._getPreferredOutput(p);return i&&Array.isArray(f)?m=m.concat(f):m.push(f),m},[]):l?[]:void 0}};S.prototype._getPreferredOutput=function(e){var t=this.currResultType;switch(t){case"all":{var n=Array.isArray(e.path)?e.path:S.toPathArray(e.path);return e.pointer=S.toPointer(n),e.path=typeof e.path=="string"?e.path:S.toPathString(e.path),e}case"value":case"parent":case"parentProperty":return e[t];case"path":return S.toPathString(e[t]);case"pointer":return S.toPointer(e.path);default:throw new TypeError("Unknown result type")}};S.prototype._handleCallback=function(e,t,n){if(t){var o=this._getPreferredOutput(e);e.path=typeof e.path=="string"?e.path:S.toPathString(e.path),t(o,n,e)}};S.prototype._trace=function(e,t,n,o,r,s,a,i){var l=this,d;if(!e.length)return d={path:n,value:t,parent:o,parentProperty:r,hasArrExpr:a},this._handleCallback(d,s,"value"),d;var u=e[0],y=e.slice(1),m=[];function p(T){Array.isArray(T)?T.forEach(function(ne){m.push(ne)}):m.push(T)}if((typeof u!="string"||i)&&t&&D.call(t,u))p(this._trace(y,t[u],W(n,u),t,u,s,a));else if(u==="*")this._walk(t,function(T){p(l._trace(y,t[T],W(n,T),t,T,s,!0,!0))});else if(u==="..")p(this._trace(y,t,n,o,r,s,a)),this._walk(t,function(T){M(t[T])==="object"&&p(l._trace(e.slice(),t[T],W(n,T),t,T,s,!0))});else{if(u==="^")return this._hasParentSelector=!0,{path:n.slice(0,-1),expr:y,isParentSelector:!0};if(u==="~")return d={path:W(n,u),value:r,parent:o,parentProperty:null},this._handleCallback(d,s,"property"),d;if(u==="$")p(this._trace(y,t,n,null,null,s,a));else if(/^(\x2D?[0-9]*):(\x2D?[0-9]*):?([0-9]*)$/.test(u))p(this._slice(u,y,t,n,o,r,s));else if(u.indexOf("?(")===0){if(this.currPreventEval)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");var f=u.replace(/^\?\(((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?)\)$/,"$1"),h=/@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])?((?:[\0->@-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)['\[](\??\((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\))(?!(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])\)\])['\]]/g.exec(f);h?this._walk(t,function(T){var ne=[h[2]],Se=h[1]?t[T][h[1]]:t[T],Te=l._trace(ne,Se,n,o,r,s,!0);Te.length>0&&p(l._trace(y,t[T],W(n,T),t,T,s,!0))}):this._walk(t,function(T){l._eval(f,t[T],T,n,o,r)&&p(l._trace(y,t[T],W(n,T),t,T,s,!0))})}else if(u[0]==="("){if(this.currPreventEval)throw new Error("Eval [(expr)] prevented in JSONPath expression.");p(this._trace(Ae(this._eval(u,t,n[n.length-1],n.slice(0,-1),o,r),y),t,n,o,r,s,a))}else if(u[0]==="@"){var g=!1,b=u.slice(1,-2);switch(b){case"scalar":(!t||!["object","function"].includes(M(t)))&&(g=!0);break;case"boolean":case"string":case"undefined":case"function":M(t)===b&&(g=!0);break;case"integer":Number.isFinite(t)&&!(t%1)&&(g=!0);break;case"number":Number.isFinite(t)&&(g=!0);break;case"nonFinite":typeof t=="number"&&!Number.isFinite(t)&&(g=!0);break;case"object":t&&M(t)===b&&(g=!0);break;case"array":Array.isArray(t)&&(g=!0);break;case"other":g=this.currOtherTypeCallback(t,n,o,r);break;case"null":t===null&&(g=!0);break;default:throw new TypeError("Unknown value type "+b)}if(g)return d={path:n,value:t,parent:o,parentProperty:r},this._handleCallback(d,s,"value"),d}else if(u[0]==="`"&&t&&D.call(t,u.slice(1))){var F=u.slice(1);p(this._trace(y,t[F],W(n,F),t,F,s,a,!0))}else if(u.includes(",")){var k=u.split(","),C=ln(k),q;try{for(C.s();!(q=C.n()).done;){var $=q.value;p(this._trace(Ae($,y),t,n,o,r,s,!0))}}catch(T){C.e(T)}finally{C.f()}}else!i&&t&&D.call(t,u)&&p(this._trace(y,t[u],W(n,u),t,u,s,a,!0))}if(this._hasParentSelector)for(var L=0;L<m.length;L++){var R=m[L];if(R&&R.isParentSelector){var U=this._trace(R.expr,t,R.path,o,r,s,a);if(Array.isArray(U)){m[L]=U[0];for(var we=U.length,te=1;te<we;te++)L++,m.splice(L,0,U[te])}else m[L]=U}}return m};S.prototype._walk=function(e,t){if(Array.isArray(e))for(var n=e.length,o=0;o<n;o++)t(o);else e&&M(e)==="object"&&Object.keys(e).forEach(function(r){t(r)})};S.prototype._slice=function(e,t,n,o,r,s,a){if(Array.isArray(n)){var i=n.length,l=e.split(":"),d=l[2]&&Number.parseInt(l[2])||1,u=l[0]&&Number.parseInt(l[0])||0,y=l[1]&&Number.parseInt(l[1])||i;u=u<0?Math.max(0,u+i):Math.min(i,u),y=y<0?Math.max(0,y+i):Math.min(i,y);for(var m=[],p=u;p<y;p+=d){var f=this._trace(Ae(p,t),n,o,r,s,a,!0);f.forEach(function(h){m.push(h)})}return m}};S.prototype._eval=function(e,t,n,o,r,s){this.currSandbox._$_parentProperty=s,this.currSandbox._$_parent=r,this.currSandbox._$_property=n,this.currSandbox._$_root=this.json,this.currSandbox._$_v=t;var a=e.includes("@path");a&&(this.currSandbox._$_path=S.toPathString(o.concat([n])));var i="script:"+e;if(!S.cache[i]){var l=e.replace(/@parentProperty/g,"_$_parentProperty").replace(/@parent/g,"_$_parent").replace(/@property/g,"_$_property").replace(/@root/g,"_$_root").replace(/@([\t-\r \)\.\[\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])/g,"_$_v$1");a&&(l=l.replace(/@path/g,"_$_path")),S.cache[i]=new this.vm.Script(l)}try{return S.cache[i].runInNewContext(this.currSandbox)}catch(d){throw new Error("jsonPath: "+d.message+": "+e)}};S.cache={};S.toPathString=function(e){for(var t=e,n=t.length,o="$",r=1;r<n;r++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(t[r])||(o+=/^[\*0-9]+$/.test(t[r])?"["+t[r]+"]":"['"+t[r]+"']");return o};S.toPointer=function(e){for(var t=e,n=t.length,o="",r=1;r<n;r++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(t[r])||(o+="/"+t[r].toString().replace(/~/g,"~0").replace(/\//g,"~1"));return o};S.toPathArray=function(e){var t=S.cache;if(t[e])return t[e].concat();var n=[],o=e.replace(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/g,";$&;").replace(/['\[](\??\((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\))['\]](?!(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])\])/g,function(s,a){return"[#"+(n.push(a)-1)+"]"}).replace(/\[["']((?:[\0-&\(-\\\^-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)["']\]/g,function(s,a){return"['"+a.replace(/\./g,"%@%").replace(/~/g,"%%@@%%")+"']"}).replace(/~/g,";~;").replace(/["']?\.["']?(?!(?:[\0-Z\\-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*\])|\[["']?/g,";").replace(/%@%/g,".").replace(/%%@@%%/g,"~").replace(/(?:;)?(\^+)(?:;)?/g,function(s,a){return";"+a.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,""),r=o.split(";").map(function(s){var a=s.match(/#([0-9]+)/);return!a||!a[1]?s:n[a[1]]});return t[e]=r,t[e].concat()};var dn=function(t,n,o){for(var r=t.length,s=0;s<r;s++){var a=t[s];o(a)&&n.push(t.splice(s--,1)[0])}},pn=function(){function e(t){pt(this,e),this.code=t}return yt(e,[{key:"runInNewContext",value:function(n){var o=this.code,r=Object.keys(n),s=[];dn(r,s,function(u){return typeof n[u]=="function"});var a=r.map(function(u){return n[u]}),i=s.reduce(function(u,y){var m=n[y].toString();return/function/.test(m)||(m="function "+m),"var "+y+"="+m+";"+u},"");o=i+o,!/(["'])use strict\1/.test(o)&&!r.includes("arguments")&&(o="var arguments = undefined;"+o),o=o.replace(/;[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*$/,"");var l=o.lastIndexOf(";"),d=l>-1?o.slice(0,l+1)+" return "+o.slice(l+1):" return "+o;return dt(Function,r.concat([d])).apply(void 0,rn(a))}}]),e}();S.prototype.vm={Script:pn};let Fe=[];class E extends Error{constructor(t){super(t),this.name="AssertionError"}}class yn{constructor(t){this.responseData=t,this.headers=new He(this.responseData.headers),this.to=new hn(this.responseData)}get code(){return this.responseData.status}get status(){return this.getStatusText(this.responseData.status)}get responseTime(){return this.responseData.duration}get responseSize(){return this.responseData.size}json(){return this.responseData.body}text(){return this.responseData.bodyText}getStatusText(t){return{200:"OK",201:"Created",204:"No Content",400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",500:"Internal Server Error",502:"Bad Gateway",503:"Service Unavailable"}[t]||"Unknown"}}class mn{constructor(t){this.requestData=t}get method(){return this.requestData.method}get url(){return new fn(this.requestData.url)}get headers(){return new He(this.requestData.headers)}get body(){return this.requestData.body}}class He{constructor(t){this.headers=t||{}}get(t){const n=t.toLowerCase();for(const o in this.headers)if(o.toLowerCase()===n)return this.headers[o]}has(t){return this.get(t)!==void 0}all(){return{...this.headers}}}class fn{constructor(t){this.urlString=t}toString(){return this.urlString}get protocol(){try{return new URL(this.urlString).protocol}catch{return""}}get host(){try{return new URL(this.urlString).host}catch{return""}}get path(){try{return new URL(this.urlString).pathname}catch{return""}}}class hn{constructor(t){this.responseData=t,this.have={status:n=>{if(this.responseData.status!==n)throw new E(`Expected status ${n}, got ${this.responseData.status}`)},header:(n,o)=>{const r=new He(this.responseData.headers);if(!r.has(n))throw new E(`Expected header '${n}' to exist`);if(o!==void 0){const s=r.get(n);if(typeof o=="string"){if(s!==o)throw new E(`Expected header '${n}' to equal '${o}', got '${s}'`)}else if(o instanceof RegExp&&!o.test(s||""))throw new E(`Expected header '${n}' to match ${o}, got '${s}'`)}},property:(n,o)=>{const r=this.responseData.body;if(typeof r!="object"||r===null)throw new E("Response body is not a JSON object");const s=n.split(".");let a=r;for(const i of s){if(a==null||!(i in a))throw new E(`Property '${n}' does not exist in response`);a=a[i]}if(o!==void 0&&a!==o)throw new E(`Expected property '${n}' to equal ${JSON.stringify(o)}, got ${JSON.stringify(a)}`)}},this.be={ok:()=>{if(this.responseData.status<200||this.responseData.status>=300)throw new E(`Expected status to be successful (200-299), got ${this.responseData.status}`)},successful:()=>{if(this.responseData.status<200||this.responseData.status>=300)throw new E(`Expected status to be successful (200-299), got ${this.responseData.status}`)}},this.include=n=>{if(!(this.responseData.bodyText||"").includes(n))throw new E(`Expected response body to include '${n}'`)},this.match=n=>{const o=this.responseData.bodyText||"";if(!n.test(o))throw new E(`Expected response body to match ${n}`)}}}class gn{get(t){return K(t)}set(t,n){be("environment",t,n).catch(console.error)}unset(t){be("environment",t,"").catch(console.error)}clear(){console.warn("pm.environment.clear() not implemented")}}class bn{get(t){return K(t)}set(t,n){be("global",t,n).catch(console.error)}unset(t){be("global",t,"").catch(console.error)}clear(){console.warn("pm.globals.clear() not implemented")}}class vn{get(t){return K(t)}set(t,n){typeof window<"u"&&(window.__pmLocalVariables=window.__pmLocalVariables||{},window.__pmLocalVariables[t]=n)}}class En{constructor(t){this.to={equal:n=>{if(this.value!==n)throw new E(`Expected ${JSON.stringify(this.value)} to equal ${JSON.stringify(n)}`)},eql:n=>{if(JSON.stringify(this.value)!==JSON.stringify(n))throw new E(`Expected ${JSON.stringify(this.value)} to deep equal ${JSON.stringify(n)}`)},be:{ok:()=>{if(!this.value)throw new E(`Expected ${JSON.stringify(this.value)} to be truthy`)},true:()=>{if(this.value!==!0)throw new E(`Expected ${JSON.stringify(this.value)} to be true`)},false:()=>{if(this.value!==!1)throw new E(`Expected ${JSON.stringify(this.value)} to be false`)},null:()=>{if(this.value!==null)throw new E(`Expected ${JSON.stringify(this.value)} to be null`)},undefined:()=>{if(this.value!==void 0)throw new E(`Expected ${JSON.stringify(this.value)} to be undefined`)},above:n=>{if(typeof this.value!="number"||this.value<=n)throw new E(`Expected ${this.value} to be above ${n}`)},below:n=>{if(typeof this.value!="number"||this.value>=n)throw new E(`Expected ${this.value} to be below ${n}`)},at:{least:n=>{if(typeof this.value!="number"||this.value<n)throw new E(`Expected ${this.value} to be at least ${n}`)},most:n=>{if(typeof this.value!="number"||this.value>n)throw new E(`Expected ${this.value} to be at most ${n}`)}},an:n=>{const o=Array.isArray(this.value)?"array":typeof this.value;if(o!==n)throw new E(`Expected ${JSON.stringify(this.value)} to be an ${n}, got ${o}`)},a:n=>{const o=Array.isArray(this.value)?"array":typeof this.value;if(o!==n)throw new E(`Expected ${JSON.stringify(this.value)} to be a ${n}, got ${o}`)}},include:n=>{if(typeof this.value=="string"){if(!this.value.includes(n))throw new E(`Expected '${this.value}' to include '${n}'`)}else if(Array.isArray(this.value)){if(!this.value.includes(n))throw new E(`Expected array to include ${JSON.stringify(n)}`)}else throw new E(`Cannot check inclusion on ${typeof this.value}`)},match:n=>{if(typeof this.value!="string")throw new E(`Expected value to be a string, got ${typeof this.value}`);if(!n.test(this.value))throw new E(`Expected '${this.value}' to match ${n}`)},have:{property:(n,o)=>{if(typeof this.value!="object"||this.value===null)throw new E(`Expected ${JSON.stringify(this.value)} to be an object`);if(!(n in this.value))throw new E(`Expected object to have property '${n}'`);if(o!==void 0&&this.value[n]!==o)throw new E(`Expected property '${n}' to equal ${JSON.stringify(o)}, got ${JSON.stringify(this.value[n])}`)},length:n=>{if(!this.value||typeof this.value.length!="number")throw new E(`Expected ${JSON.stringify(this.value)} to have length property`);if(this.value.length!==n)throw new E(`Expected length ${n}, got ${this.value.length}`)}}},this.value=t}}class wn{constructor(){this.response=null,this.request=null,this.environment=new gn,this.globals=new bn,this.variables=new vn,this.info={requestName:"",requestId:"",iteration:1}}test(t,n){try{n(),Fe.push({name:t,passed:!0}),console.log(`✓ ${t}`)}catch(o){Fe.push({name:t,passed:!1,error:o.message}),console.error(`✗ ${t}: ${o.message}`)}}expect(t){return new En(t)}sendRequest(){console.warn("pm.sendRequest() not implemented in this environment")}}const oe=new wn,Sn={log:(...e)=>console.log("[PM Console]",...e),info:(...e)=>console.info("[PM Console]",...e),warn:(...e)=>console.warn("[PM Console]",...e),error:(...e)=>console.error("[PM Console]",...e)};async function Tn(e,t,n){Fe=[],oe.response=new yn(t),oe.request=new mn(n),oe.info.requestName=n.name,oe.info.requestId=n.id;const o={pm:oe,console:Sn,JSONPath:S,_:(typeof window<"u"?window._:void 0)||{},CryptoJS:(typeof window<"u"?window.CryptoJS:void 0)||{}};try{return new Function(...Object.keys(o),e)(...Object.values(o)),Fe}catch(r){return console.error("Postman test script execution error:",r),[{name:"Script Execution Error",passed:!1,error:r.message}]}}function Fn(e){return/\bpm\.|pm\.test\(|pm\.expect\(|pm\.response|pm\.request|pm\.environment|pm\.globals/.test(e)}typeof window<"u"&&(window.pm=oe);function Ve(){const e=document.getElementById("historyContainer");if(c.history.length===0){e.innerHTML='<p class="empty-message">No request history</p>';return}e.innerHTML="",c.history.forEach(t=>{var a,i,l;const n=document.createElement("div");n.className="history-item",n.dataset.id=t.id.toString();const o=((a=t.request)==null?void 0:a.method)||"GET",r=((i=t.request)==null?void 0:i.url)||"",s=((l=t.response)==null?void 0:l.status)||0;n.innerHTML=`
            <span class="history-method method-${o}">${o}</span>
            <span class="history-url">${_(r)}</span>
            <span class="history-status status-${s<400?"success":"error"}">${s||"N/A"}</span>
            <span class="history-time">${new Date(t.timestamp).toLocaleTimeString()}</span>
        `,n.addEventListener("click",()=>qn(t.id)),e.appendChild(n)})}async function kn(e,t,n=[]){const o={id:Date.now().toString(),timestamp:new Date().toISOString(),request:{id:e.id,name:e.name,method:e.method,url:e.url,headers:e.headers,params:e.params,body:e.body,bodyType:e.bodyType,auth:e.auth,preRequestScript:e.preRequestScript,testScript:e.testScript},response:{status:t.status,statusText:t.statusText,headers:t.headers,body:t.body,bodyText:t.bodyText,duration:t.duration,size:t.size,testResults:n}};c.history.unshift(o),c.history.length>100&&c.history.splice(100),await Mt(),Ve()}async function qn(e){const t=c.history.find(o=>o.id===e);if(!t||!t.request)return;const n={...t.request,lastResponseExecution:t.response?{status:t.response.status,duration:t.response.duration,size:t.response.size,timestamp:t.timestamp,headers:t.response.headers,body:t.response.body,testResults:t.response.testResults||[]}:void 0};G(n),ve("request"),w("Request and response loaded from history")}async function Bn(){confirm("Are you sure you want to clear all request history?")&&(c.history.length=0,await Mt(),Ve(),w("History cleared"))}function Cn(){const t=document.getElementById("historySearch").value.toLowerCase();document.querySelectorAll(".history-item").forEach(o=>{var d,u;const r=o,s=r.querySelector(".history-url"),a=r.querySelector(".history-method"),i=((d=s.textContent)==null?void 0:d.toLowerCase())||"",l=((u=a.textContent)==null?void 0:u.toLowerCase())||"";i.includes(t)||l.includes(t)?r.style.display="flex":r.style.display="none"})}function xn(e){return{200:"OK",201:"Created",204:"No Content",400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",500:"Internal Server Error",502:"Bad Gateway",503:"Service Unavailable"}[e]||"Unknown"}function $n(){const e=document.getElementById("responseStats");e&&(e.innerHTML='<span class="no-response">No response yet</span>');const t=document.getElementById("responseBody");t&&(t.innerHTML='<div class="no-response">Send a request to see the response</div>');const n=document.getElementById("response-headers");n&&(n.innerHTML='<div class="no-response">No headers</div>');const o=document.getElementById("response-cookies");o&&(o.innerHTML='<div class="no-response">No cookies</div>');const r=document.getElementById("response-tests");r&&(r.innerHTML='<div class="no-response">No tests run</div>')}function G(e){var p;console.log("loadRequestIntoEditor called with request:",e),console.log("Request params from input:",e.params),c.currentRequest=JSON.parse(JSON.stringify(e)),console.log("After setting state.currentRequest.params:",(p=c.currentRequest)==null?void 0:p.params);const t=document.getElementById("request-name-display");t&&(t.innerHTML=`<input type="text" id="nameInput" value="${e.name}"></input>`);const n=document.getElementById("request-id-display");n&&(n.innerHTML=`<span>Request ID: <em>${e.id}</em></span>`);const o=document.getElementById("methodSelect"),r=document.getElementById("urlInput");o.value=e.method,r.value=e.url;const s=document.getElementById("headersContainer");s.innerHTML="",e.headers&&Object.keys(e.headers).length>0?Object.entries(e.headers).forEach(([f,h])=>{x(s,"header");const g=s.querySelectorAll(".key-value-row"),b=g[g.length-1],F=b.querySelector(".key-input"),k=b.querySelector(".value-input");F.value=f,k.value=h}):x(s,"header");const a=document.getElementById("paramsContainer");if(a.innerHTML="",console.log("Loading request params:",e.params),console.log("ParamsContainer element:",a),e.params&&Object.keys(e.params).length>0){const f=Object.entries(e.params);f.forEach(()=>{x(a,"param")}),setTimeout(()=>{const g=a.querySelectorAll(".key-value-row");console.log(`Found ${g.length} rows, expected ${f.length}`),f.forEach(([b,F],k)=>{if(k<g.length){const C=g[k],q=C.querySelector(".key-input"),$=C.querySelector(".value-input");q&&$?(q.value=b,$.value=F,console.log(`Set param ${k}: ${b} = ${F}`),q.dispatchEvent(new Event("input",{bubbles:!0})),$.dispatchEvent(new Event("input",{bubbles:!0}))):console.error(`Could not find input elements in row ${k}`)}else console.error(`Row ${k} not found`)})},50),c.currentRequest&&(c.currentRequest.params={...e.params},console.log("Updated state.currentRequest.params:",c.currentRequest.params));const h=document.getElementById("preRequestScript");h.value=e.preRequestScript||"",X(h)}else console.log("No params to load, adding empty row"),x(a,"param");if(e.body)if(e.bodyType==="binary"){const f=document.getElementById("binaryFileInput"),h=document.getElementById("binaryFileInfo");if(e.body instanceof File)f.files=new DataTransfer().files,h.textContent=`Saved: ${e.body.name} (${J(e.body.size)})`;else if(typeof e.body=="string")try{const g=JSON.parse(e.body),b=ae(g.base64Data,g.fileName,g.fileType);c.currentRequest.body=b,h.textContent=`Restored: ${g.fileName} (${J(g.fileSize)})`}catch{console.warn("binary の復元に失敗")}}else if(typeof e.body=="string"){const f=document.querySelector('input[name="bodyType"][value="raw"]');f.checked=!0,V({target:{value:"raw"}});const h=document.getElementById("rawBody");h.value=e.body}else{const f=document.querySelector('input[name="bodyType"][value="form-data"]');f.checked=!0,V({target:{value:"form-data"}});const h=document.getElementById("formDataFieldsContainer");h&&(h.innerHTML="",Array.isArray(e.body)?(console.log("🔍 [loadRequestIntoEditor] FormDataField[]形式で復元:",e.body),e.body.forEach(g=>{var L;x(h,"body");const b=h.querySelectorAll(".key-value-row"),F=b[b.length-1],k=F.querySelector(".key-input"),C=F.querySelector(".value-type-select"),q=F.querySelector(".value-input"),$=F.querySelector(".file-input");if(k.value=g.key,g.type==="file"){if(C.value="file",q.style.display="none",$.style.display="block",g.fileName){const R=document.createElement("span");R.textContent=`Saved: ${g.fileName}`,R.style.color="#666",R.style.fontSize="12px",R.style.marginLeft="8px",R.dataset.fileInfo=JSON.stringify({fileName:g.fileName,fileType:g.fileType,fileSize:g.fileSize,fileContent:g.fileContent}),(L=$.parentNode)==null||L.appendChild(R)}}else C.value="text",q.style.display="block",$.style.display="none",q.value=g.value||""})):(console.log("🔍 [loadRequestIntoEditor] Record形式で復元:",e.body),Object.entries(e.body).forEach(([g,b])=>{x(h,"body");const F=h.querySelectorAll(".key-value-row"),k=F[F.length-1],C=k.querySelector(".key-input"),q=k.querySelector(".value-input");C.value=g,q.value=b})))}else{const f=document.querySelector('input[name="bodyType"][value="none"]');f.checked=!0,V({target:{value:"none"}})}if(e.auth){const f=document.getElementById("authType");switch(f.value=e.auth.type||"none",$e(e.auth.type),e.auth.type){case"basic":const h=document.getElementById("authUsername"),g=document.getElementById("authPassword");h.value=e.auth.username||"",g.value=e.auth.password||"";break;case"bearer":const b=document.getElementById("authToken");b.value=e.auth.token||"";break;case"apikey":const F=document.getElementById("authKey"),k=document.getElementById("authValue"),C=document.getElementById("authAddTo");F.value=e.auth.key||"",k.value=e.auth.value||"",C.value=e.auth.addTo||"header";break;case"oauth2":const q=document.getElementById("authAccessToken"),$=document.getElementById("authTokenType");q.value=e.auth.accessToken||"",$.value=e.auth.tokenType||"Bearer";break}ge()}const i=e.bodyType||"none",l=document.querySelector(`input[name="bodyType"][value="${i}"]`);if(l)l.checked=!0,V({target:{value:i}});else{const f=document.querySelector('input[name="bodyType"][value="none"]');f&&(f.checked=!0,V({target:{value:"none"}}))}const d=document.getElementById("rawBody"),u=document.getElementById("jsonBody");if(d&&(d.value=e.body||""),u&&(u.value=e.body||""),i==="binary"){const f=document.getElementById("binaryFileInput"),h=document.getElementById("binaryFileInfo");if(e.body instanceof File)h&&(h.innerHTML=`
                    <div class="saved-binary-file">
                        <span class="file-name">Saved: ${e.body.name}</span>
                        <span class="file-size">(${J(e.body.size)})</span>
                        <span class="file-type">${e.body.type||"Unknown type"}</span>
                    </div>
                `,f&&(f.dataset.savedFile=JSON.stringify({name:e.body.name,size:e.body.size,type:e.body.type}))),console.log("🔍 [loadRequestIntoEditor] Binary file restored:",{name:e.body.name,size:e.body.size,type:e.body.type});else if(typeof e.body=="string")try{const g=JSON.parse(e.body);if(g.type==="binaryFile"&&g.base64Data){const b=ae(g.base64Data,g.fileName,g.fileType);f&&h&&(h.innerHTML=`
                            <div class="saved-binary-file">
                                <span class="file-name">Restored: ${g.fileName}</span>
                                <span class="file-size">(${J(g.fileSize||0)})</span>
                                <span class="file-type">${g.fileType||"Unknown type"}</span>
                            </div>
                        `,c.currentRequest&&(c.currentRequest.body=b)),console.log("🔍 [loadRequestIntoEditor] Binary file restored from Base64:",{name:g.fileName,size:g.fileSize,type:g.fileType})}}catch(g){console.error("🔍 [loadRequestIntoEditor] Failed to restore binary file:",g)}}const y=document.getElementById("preRequestScript");y&&(y.value=e.preRequestScript||"");const m=document.getElementById("testScript");if(m&&(m.value=e.testScript||""),e.lastRequestExecution||e.lastResponseExecution){if(e.lastResponseExecution){const f=typeof e.lastResponseExecution.body=="string"?e.lastResponseExecution.body:JSON.stringify(e.lastResponseExecution.body,null,2),h={status:e.lastResponseExecution.status,statusText:xn(e.lastResponseExecution.status),headers:e.lastResponseExecution.headers||{},duration:e.lastResponseExecution.duration,size:e.lastResponseExecution.size,body:e.lastResponseExecution.body,bodyText:f};Je(h),e.lastResponseExecution.testResults&&ye(e.lastResponseExecution.testResults)}}else $n();ve("request")}async function Rn(e,t,n){const o=document.getElementById("response-tests");o&&(o.innerHTML='<div class="no-response">Tests are running...</div>');let r;if(t!==void 0)r=t;else{const i=document.getElementById("testScript");r=(i==null?void 0:i.value)||""}if(console.log("実行するテストスクリプト:",r),!(r!=null&&r.trim()))return o&&(o.innerHTML='<div class="no-response">No tests to execute</div>'),[];if(Fn(r)){console.log("Postman形式のテストスクリプトを実行します");try{const i=await Tn(r,e,n||c.currentRequest||{});return ye(i),i}catch(i){console.error("Postman test script 実行エラー:",i);const l={name:"Postman Script Execution Error",passed:!1,error:i.message};return ye([l]),[l]}}console.log("従来のコマンド形式のテストスクリプトを実行します");const s=r.split(/\r?\n/).map(i=>i.trim()).filter(i=>i!==""&&!i.startsWith("//"));console.log("実行するテストコマンド一覧:",s),console.log("レスポンスデータ:",e);const a=[];try{for(const i of s){console.log("実行中のテストコマンド:",i);const l=Un(i,e);console.log("テストコマンド結果:",l),a.push({name:i,passed:l.passed,error:l.error})}return ye(a),a}catch(i){console.error("Test script 実行エラー:",i);const l={name:"Script Execution Error",passed:!1,error:i.message};return a.push(l),ye(a),a}}async function In(e,t,n,o){var r;if(c.currentCollection){const s=c.collections.find(a=>a.id===c.currentCollection);if(s){const a=s.requests.find(i=>i.id===e);a&&(a.lastRequestExecution=t,a.lastResponseExecution={status:n.status,duration:n.duration,size:n.size,timestamp:new Date().toISOString(),headers:n.headers,body:n.body,testResults:o})}await P()}if(c.scenarios.forEach(s=>{const a=(s.requests||[]).find(i=>i.id===e);a&&(console.log(`🔍 [saveExecutionResult] Saving execution result for scenario "${s.name}" request "${a.name}"`),a.lastRequestExecution=t,a.lastResponseExecution={status:n.status,duration:n.duration,size:n.size,timestamp:new Date().toISOString(),headers:n.headers,body:n.body,testResults:o},console.log("🔍 [saveExecutionResult] Saved response data:",{status:n.status,headers:Object.keys(n.headers||{}),bodyType:typeof n.body}))}),await A(),((r=c.currentRequest)==null?void 0:r.id)===e){const s=c.currentRequest;s.lastRequestExecution=t,s.lastResponseExecution={status:n.status,duration:n.duration,size:n.size,timestamp:new Date().toISOString(),headers:n.headers,body:n.body,testResults:o}}}async function ft(e,t=!1){var o;Ne(!0);let n=e;try{if(!((o=e.url)!=null&&o.trim()))return v("URL is required","Please enter a valid URL in the format: http://example.com or https://example.com"),"";try{n=Kn(e)}catch(p){return console.error("Variable processing error:",p),Be("Request processing",p),""}try{n=Wn(n.preRequestScript||"",n)}catch(p){return console.error("Pre-request script error:",p),v("Pre-request script execution failed",`Error: ${p.message}

Please check your pre-request script syntax and variable references.`),""}const r={timestamp:new Date().toISOString(),method:n.method,url:n.url,headers:n.headers,params:n.params,body:n.body,auth:n.auth,folder:n.folder||"",description:n.description||"",bodyType:n.bodyType||"none",preRequestScript:n.preRequestScript||""},s=Ln(n);if(!s)return"";const{method:a,headers:i,bodyData:l,url:d}=s;console.log("🍪 Always using sendRequestWithCookieSupport");const u=await _n({method:a,url:d,headers:i,body:l}),y=await Pn(u,u.duration||0);t||Je(y);const m=await Rn(y,e.testScript,e);return await Gn(n,y,m),await In(e.id,r,y,m),t?{response:y,testResults:m}:u}catch(r){console.error("Request error:",r),r.message.includes("Network")||r.message.includes("fetch")||r.message.includes("CORS")||r.message.includes("timeout")?Ct(n.url||e.url,r):r.message.includes("Variable")||r.message.includes("変数")?Be("Request execution",r):r.message.includes("Invalid URL")?v("Invalid URL format",`The URL "${n.url||e.url}" is not valid. Please check the URL format and ensure all variables are properly resolved.`):r.message.includes("JSON")||r.message.includes("parse")?v("Response parsing failed",`Unable to parse the response as JSON. The server may have returned invalid JSON or a different content type.

Error: ${r.message}`):v("Request failed",`An unexpected error occurred while processing your request.

Error: ${r.message}

Please check your request configuration and try again.`)}finally{Ne(!1)}return""}function Dn(e){return new Promise((t,n)=>{var r,s;if(console.log("🔍 [fileToBase64] 開始. file詳細:",{file:e,name:e==null?void 0:e.name,size:e==null?void 0:e.size,type:e==null?void 0:e.type,instanceof_File:e instanceof File,instanceof_Blob:e instanceof Blob,constructor:(r=e==null?void 0:e.constructor)==null?void 0:r.name,typeof:typeof e}),!e){console.error("🔍 [fileToBase64] ファイルオブジェクトがnullまたはundefined"),n(new Error("File object is null or undefined"));return}if(!(e instanceof File)&&!(e instanceof Blob)){console.error("🔍 [fileToBase64] ファイルオブジェクトがFile/Blobインスタンスではありません"),n(new Error(`File object is not a File or Blob instance. Type: ${typeof e}, Constructor: ${(s=e==null?void 0:e.constructor)==null?void 0:s.name}`));return}const o=new FileReader;o.onload=()=>{console.log("🔍 [fileToBase64] FileReader.onload成功");const i=o.result.split(",")[1];console.log("🔍 [fileToBase64] Base64変換完了. 長さ:",(i==null?void 0:i.length)||0),t(i)},o.onerror=a=>{console.error("🔍 [fileToBase64] FileReader.onerror:",a),n(a)};try{console.log("🔍 [fileToBase64] FileReader.readAsDataURL呼び出し開始"),o.readAsDataURL(e)}catch(a){console.error("🔍 [fileToBase64] FileReader.readAsDataURL呼び出しでエラー:",a),n(a)}})}function Ln(e){const t=(e.method||"GET").toUpperCase(),n={};let o=null;e.headers&&Object.assign(n,e.headers),On(n,e.auth);let r=e.url;if(e.body&&t!=="GET"&&t!=="HEAD")switch(e.bodyType||"none"){case"raw":{o=e.body.toString();break}case"json":{o=typeof e.body=="string"?e.body:JSON.stringify(e.body),n["Content-Type"]="application/json";break}case"form-data":{if(console.log("🔍 [buildFetchOptions] form-data処理. request.body:",e.body),Array.isArray(e.body))console.log("🔍 [buildFetchOptions] FormDataField[]配列をそのまま返す"),o=e.body;else{console.log("🔍 [buildFetchOptions] 古いロジック（collectKeyValues）を使用");const a=new FormData,i=Q("formDataFieldsContainer");Object.entries(i).forEach(([l,d])=>{a.append(l,d)}),o=a}break}case"urlencoded":{const a=new URLSearchParams,i=Q("formDataFieldsContainer");Object.entries(i).forEach(([l,d])=>{a.append(l,d)}),o=a.toString(),n["Content-Type"]="application/x-www-form-urlencoded";break}case"binary":{e.body instanceof File?(console.log("🔍 [buildFetchOptions] Binary file処理:",{name:e.body.name,size:e.body.size,type:e.body.type}),o=e.body,!n["Content-Type"]&&e.body.type&&(n["Content-Type"]=e.body.type)):console.log("🔍 [buildFetchOptions] Binary body is not a File object");break}}return{method:t,headers:n,bodyData:o,url:r}}async function _n(e){return console.log("🍪 sendRequestWithCookieSupport called with:",e),new Promise(async(t,n)=>{var a,i,l,d,u,y;const o=Date.now();let r=null,s=!1;try{if(console.log("🔍 [requestManager.ts] bodyの処理開始. options.body:",e.body),console.log("🔍 [requestManager.ts] options.body type:",typeof e.body),console.log("🔍 [requestManager.ts] options.body instanceof FormData:",e.body instanceof FormData),console.log("🔍 [requestManager.ts] Array.isArray(options.body):",Array.isArray(e.body)),e.body instanceof FormData){console.log("🔍 [requestManager.ts] FormDataオブジェクトとして処理");const p={};for(const[f,h]of e.body.entries())p[f]=h.toString();r=JSON.stringify(p),console.log("🔍 [requestManager.ts] FormData処理完了:",p)}else if(Array.isArray(e.body)){console.log("🔍 [requestManager.ts] FormDataField[]配列として処理");const p=e.body;console.log("🔍 [requestManager.ts] formDataFields:",p);const f=[];for(const h of p)if(console.log("🔍 [requestManager.ts] 処理中のfield:",h),console.log("🔍 [requestManager.ts] field.file詳細:",{file:h.file,fileType:typeof h.file,isBlob:h.file instanceof Blob,isFile:h.file instanceof File,constructor:(i=(a=h.file)==null?void 0:a.constructor)==null?void 0:i.name}),h.type==="file"&&h.file){if(!(h.file instanceof File)&&!(h.file instanceof Blob)){console.error("🔍 [requestManager.ts] field.fileがFile/Blobではありません:",h.file),f.push({key:h.key,type:"text",value:`[File Error: ${h.file}]`});continue}console.log("🔍 [requestManager.ts] ファイルフィールドを処理:",{key:h.key,filename:h.file.name,size:h.file.size,type:h.file.type}),s=!0,console.log("🔍 [requestManager.ts] Base64変換開始..."),console.log("🔍 [requestManager.ts] fileToBase64に渡すfile:",h.file),console.log("🔍 [requestManager.ts] fileToBase64に渡すfile詳細2:",{file:h.file,typeof:typeof h.file,instanceof_File:h.file instanceof File,instanceof_Blob:h.file instanceof Blob,constructor_name:(d=(l=h.file)==null?void 0:l.constructor)==null?void 0:d.name,Object_prototype_toString:Object.prototype.toString.call(h.file)});const g=await Dn(h.file);console.log("🔍 [requestManager.ts] Base64変換完了. データ長:",g.length),f.push({key:h.key,type:"file",filename:h.file.name,contentType:h.file.type,data:g})}else console.log("🔍 [requestManager.ts] テキストフィールドを処理:",{key:h.key,value:h.value}),f.push({key:h.key,type:"text",value:h.value||""});r=JSON.stringify(f),console.log("🔍 [requestManager.ts] 配列処理完了. hasFiles:",s),console.log("🔍 [requestManager.ts] processedFields:",f)}else if(e.body instanceof File){console.log("🔍 [requestManager.ts] Binary File として処理");const p=await e.body.arrayBuffer();r=JSON.stringify({type:"binary",filename:e.body.name,contentType:e.body.type,arrayBuffer:Array.from(new Uint8Array(p))}),s=!0,console.log("🔍 [requestManager.ts] Binary File 処理完了:",{filename:e.body.name,size:e.body.size,contentType:e.body.type,arrayBufferSize:p.byteLength})}else typeof e.body=="string"?(console.log("🔍 [requestManager.ts] 文字列として処理"),r=e.body):(u=e.body)!=null&&u.toString&&e.body.toString()!=="[object Object]"&&(console.log("🔍 [requestManager.ts] toString()で処理"),r=e.body.toString());const m={action:"sendHttpRequest",options:{method:e.method,url:e.url,headers:e.headers,body:r,isFormData:e.body instanceof FormData||Array.isArray(e.body)||e.body instanceof File,hasFiles:s}};console.log("🔍 [requestManager.ts] messageData作成完了:",{action:m.action,method:m.options.method,url:m.options.url,headers:m.options.headers,bodyType:typeof m.options.body,bodyLength:((y=m.options.body)==null?void 0:y.length)||0,isFormData:m.options.isFormData,hasFiles:m.options.hasFiles}),console.log("🔍 [requestManager.ts] Sending message to background script for Cookie handling"),chrome.runtime.sendMessage(m,p=>{if(console.log("Received response from background script:",p),chrome.runtime.lastError){console.error("Chrome runtime error:",chrome.runtime.lastError.message),n(new Error(chrome.runtime.lastError.message));return}if(p.success){const f=Date.now()-o,h={status:p.status,statusText:p.statusText,headers:p.headers,text:async()=>p.body,json:async()=>{try{return JSON.parse(p.body)}catch{return{}}},duration:f};console.log("Constructed Cookie XhrResponse:",h),t(h)}else console.error("Background script returned error:",p.error),n(new Error(p.error||"Cookie request failed"))})}catch(m){console.error("Error processing request body:",m),n(new Error(`Request processing failed: ${m.message}`))}})}function On(e,t){switch(t.type){case"basic":if(t.username&&t.password){const n=btoa(`${t.username}:${t.password}`);e.Authorization=`Basic ${n}`}break;case"bearer":t.token&&(e.Authorization=`Bearer ${t.token}`);break;case"apikey":t.key&&t.value&&t.addTo==="header"&&(e[t.key]=t.value);break;case"oauth2":t.accessToken&&(e.Authorization=`${t.tokenType||"Bearer"} ${t.accessToken}`);break}}async function Pn(e,t){const n={status:e.status,statusText:e.statusText,headers:{},duration:t,size:0,body:null,bodyText:""};e.headers&&Object.entries(e.headers).forEach(([r,s])=>{n.headers[r]=s});const o=n.headers["content-type"]||"";try{if(n.bodyText=await e.text(),n.size=new Blob([n.bodyText]).size,o.includes("application/json"))try{n.body=JSON.parse(n.bodyText)}catch{n.body=n.bodyText}else n.body=n.bodyText}catch{n.bodyText="Error reading response body",n.body=null}return n}function Je(e,t="pretty"){window.lastResponse=e;const n=document.getElementById("responseStats");n.innerHTML=`
        <span class="status-${e.status<400?"success":"error"}">
            ${e.status} ${e.statusText}
        </span>
        <span>${e.duration}ms</span>
        <span>${J(e.size)}</span>
    `,Vn(e,t),Jn(e.headers),zn(e.headers)}function An(e){try{const n=new DOMParser().parseFromString(e,"application/xml");return n.querySelector("parsererror")?e:new XMLSerializer().serializeToString(n).replace(/></g,`>
<`).replace(/^\s*\n/gm,"").split(`
`).map(s=>{const a=(s.match(/</g)||[]).length-(s.match(/\//g)||[]).length;return"  ".repeat(Math.max(0,a))+s.trim()}).join(`
`)}catch{return e}}function Nn(e){try{return e.replace(/></g,`>
<`).replace(/^\s*\n/gm,"").split(`
`).map(t=>t.trim()).filter(t=>t.length>0).map((t,n,o)=>{const r=o[n-1],s=r?(r.match(/</g)||[]).length-(r.match(/\//g)||[]).length:0;return"  ".repeat(Math.max(0,s))+t}).join(`
`)}catch{return e}}function jn(e){try{return e.replace(/\{/g,` {
`).replace(/\}/g,`
}
`).replace(/;/g,`;
`).split(`
`).map(t=>t.trim()).filter(t=>t.length>0).map(t=>t.includes("{")&&!t.includes("}")||t==="}"?t:"  "+t).join(`
`)}catch{return e}}function Mn(e){try{return e.replace(/\{/g,` {
`).replace(/\}/g,`
}
`).replace(/;/g,`;
`).replace(/,/g,`,
`).split(`
`).map(t=>t.trim()).filter(t=>t.length>0).map((t,n,o)=>{const r=(t.match(/\{/g)||[]).length,s=(t.match(/\}/g)||[]).length,i=o.slice(0,n).reduce((l,d)=>l+(d.match(/\{/g)||[]).length-(d.match(/\}/g)||[]).length,0);return s>0&&r===0?"  ".repeat(Math.max(0,i-s))+t:"  ".repeat(Math.max(0,i))+t}).join(`
`)}catch{return e}}function Hn(e,t){const n=e.toLowerCase();if(n.includes("json"))return"json";if(n.includes("xml"))return"xml";if(n.includes("html"))return"html";if(n.includes("css"))return"css";if(n.includes("javascript")||n.includes("text/js"))return"javascript";const o=t.trim();if(o.startsWith("{")||o.startsWith("["))try{return JSON.parse(o),"json"}catch{}return o.startsWith("<")&&(o.includes("<?xml")||o.includes("<"))?o.includes("<!DOCTYPE html")||o.includes("<html")?"html":"xml":"text"}function Vn(e,t){const n=document.getElementById("responseBody");let o="";const r=e.headers["content-type"]||"",s=Hn(r,e.bodyText);switch(t){case"pretty":switch(s){case"json":try{if(typeof e.body=="object")o=JSON.stringify(e.body,null,2);else{const a=JSON.parse(e.bodyText);o=JSON.stringify(a,null,2)}}catch{o=e.bodyText}break;case"xml":o=An(e.bodyText);break;case"html":o=Nn(e.bodyText);break;case"css":o=jn(e.bodyText);break;case"javascript":o=Mn(e.bodyText);break;default:o=e.bodyText;break}break;case"raw":o=e.bodyText;break;case"preview":if(s==="html"){n.innerHTML=`<iframe srcdoc="${_(e.bodyText)}" style="width:100%;height:300px;border:1px solid #ccc;"></iframe>`;return}else if(s==="json")try{const a=typeof e.body=="object"?e.body:JSON.parse(e.bodyText);o=`<pre style="background:#f5f5f5;padding:10px;border-radius:4px;overflow:auto;">${JSON.stringify(a,null,2)}</pre>`,n.innerHTML=o;return}catch{o=e.bodyText}else o=e.bodyText;break}n.innerHTML=`<pre class="response-content response-${s}">${_(o)}</pre>`}function Jn(e){const t=document.getElementById("response-headers");let n='<div class="headers-list">';Object.entries(e).forEach(([o,r])=>{n+=`<div class="header-item"><span class="header-key">${_(o)}</span><span class="header-value">${_(r)}</span></div>`}),n+="</div>",t.innerHTML=n}function zn(e){const t=document.getElementById("response-cookies"),n=e["set-cookie"],o=e.cookie,r=[];if(n&&(Array.isArray(n)?r.push(...n):r.push(n)),o&&(Array.isArray(o)?r.push(...o):r.push(o)),r.length>0){let s='<div class="cookies-list">';r.forEach(a=>{a.split(";").map(l=>l.trim()).filter(l=>l.length>0).forEach(l=>{s+=`<div class="cookie-item">${_(l)}</div>`})}),s+="</div>",t.innerHTML=s}else t.innerHTML='<p class="empty-message">No cookies in response</p>'}function Un(e,t){const[n,...o]=e.trim().split(/\s+/);switch(n){case"status":{const r=parseInt(o[0],10);return t.status!==r?{passed:!1,error:`Expected status ${r}, got ${t.status}`}:{passed:!0}}case"jsonHasProperty":{const r=o[0],s=t.body;return typeof s!="object"||s===null?{passed:!1,error:"レスポンスボディが JSON オブジェクトではありません"}:r in s?{passed:!0}:{passed:!1,error:`JSON にプロパティ "${r}" が見つかりません`}}case"jsonArrayLengthEquals":{const[r,s]=o,a=parseInt(s,10),i=t.body;if(typeof i!="object"||i===null)return{passed:!1,error:"レスポンスボディが JSON オブジェクトではありません"};const l=r.split(".").reduce((d,u)=>d&&d[u]!==void 0?d[u]:void 0,i);return Array.isArray(l)?l.length!==a?{passed:!1,error:`Expected ${r}.length === ${a}, got ${l.length}`}:{passed:!0}:{passed:!1,error:`パス "${r}" に対応する値が配列ではありません`}}case"bodyContains":{const r=o.join(" ");return(t.bodyText??"").includes(r)?{passed:!0}:{passed:!1,error:`レスポンスボディに "${r}" が含まれていません`}}case"setVarFromHeader":{const r=o[0],s=o.slice(1).join(" "),a=t.headers||{},i=s.toLowerCase();let l;for(const d in a)if(d.toLowerCase()===i){l=a[d];break}return l===void 0?{passed:!1,error:`レスポンスヘッダー "${s}" が見つかりません`}:(console.log("取得したAuthorizationヘッダ：varName=",r),console.log("取得したAuthorizationヘッダ：headerValue=",l),be("environment",r,l).catch(console.error),N("environment"),{passed:!0})}case"jsonValueEquals":{const r=o[0],s=o.slice(1).join(" "),a=isNaN(Number(s))?s:Number(s);let i;if(typeof t.bodyText=="string")try{i=JSON.parse(t.bodyText)}catch{return{passed:!1,error:"レスポンスボディが有効な JSON ではありません"}}else i=t.body;const l=r.split(".").reduce((d,u)=>{if(d&&u in d)return d[u];if(u==="length"&&Array.isArray(d))return d.length},i);return l===void 0?{passed:!1,error:`パス "${r}" が見つかりません`}:l!==a?{passed:!1,error:`期待値: ${a} ですが、実際の値: ${l} です`}:{passed:!0}}case"headerExists":{const r=o[0].toLowerCase();return Object.keys(t.headers).some(a=>a.toLowerCase()===r)?{passed:!0}:{passed:!1,error:`ヘッダー "${o[0]}" が存在しません`}}case"headerValueEquals":{const r=o[0].toLowerCase(),s=o.slice(1).join(" ");let a;for(const[i,l]of Object.entries(t.headers))if(i.toLowerCase()===r){a=l;break}return a===void 0?{passed:!1,error:`ヘッダー "${o[0]}" が存在しません`}:a!==s?{passed:!1,error:`"${o[0]}" の値が期待値と異なります (期待: ${s}, 実際: ${a})`}:{passed:!0}}case"echoRequestHeaderEquals":{const r=o[0],s=o.slice(1).join(" ");try{let a=t.body;if(typeof a=="string")try{a=JSON.parse(a)}catch{return{passed:!1,error:"レスポンスボディのJSONパースに失敗しました"}}if(typeof a=="object"&&a.headers){const i=a.headers,l=r.toLowerCase(),d=i[l];return d===void 0?{passed:!1,error:`エコーされたリクエストヘッダー "${r}" が見つかりません`}:d!==s?{passed:!1,error:`エコーされたヘッダー "${r}" の値が期待値と異なります (期待: ${s}, 実際: ${d})`}:{passed:!0}}else return{passed:!1,error:"レスポンスボディにheaders情報が含まれていません"}}catch(a){return{passed:!1,error:`レスポンスボディの解析に失敗しました: ${a}`}}}case"echoRequestHeaderContains":{const r=o[0],s=o.slice(1).join(" ");try{let a=t.body;if(typeof a=="string"&&(a=JSON.parse(a)),typeof a=="object"&&a.headers){const i=a.headers,l=r.toLowerCase(),d=i[l];if(d===void 0)return{passed:!1,error:`エコーされたリクエストヘッダー "${r}" が見つかりません`};if(l==="cookie"){const u=d.split(";").map(p=>p.trim()).filter(p=>p.length>0),m=s.split(";").map(p=>p.trim()).filter(p=>p.length>0).filter(p=>!u.includes(p));return m.length===0?{passed:!0}:{passed:!1,error:`Cookie ヘッダーに以下のペアが含まれていません: ${m.join(", ")} (実際: ${d})`}}return d.includes(s)?{passed:!0}:{passed:!1,error:`エコーされたヘッダー "${r}" に "${s}" が含まれていません (実際: ${d})`}}else return{passed:!1,error:"レスポンスボディに headers 情報が含まれていません"}}catch(a){return{passed:!1,error:`レスポンスボディの解析に失敗しました: ${a}`}}}case"echoRequestMethodEquals":{const r=o[0];try{let s=t.body;if(typeof s=="string")try{s=JSON.parse(s)}catch{return{passed:!1,error:"レスポンスボディのJSONパースに失敗しました"}}if(typeof s=="object"&&s.method){const a=s.method;return a!==r?{passed:!1,error:`エコーされたメソッド "${a}" が期待値 "${r}" と異なります`}:{passed:!0}}else return{passed:!1,error:"レスポンスボディにmethod情報が含まれていません"}}catch(s){return{passed:!1,error:`レスポンスボディの解析に失敗しました: ${s}`}}}case"echoRequestBodyEquals":{const r=o.join(" ");try{let s=t.body;if(typeof s=="string")try{s=JSON.parse(s)}catch{return{passed:!1,error:"レスポンスボディのJSONパースに失敗しました"}}if(typeof s=="object"&&s.body!==void 0){const a=s.body;return a!==r?{passed:!1,error:`エコーされたボディが期待値と異なります
期待: ${r}
実際: ${a}`}:{passed:!0}}else return{passed:!1,error:"レスポンスボディにbody情報が含まれていません"}}catch(s){return{passed:!1,error:`レスポンスボディの解析に失敗しました: ${s}`}}}case"echoRequestUrlContains":{const r=o.join(" ");try{let s=t.body;if(typeof s=="string")try{s=JSON.parse(s)}catch{return{passed:!1,error:"レスポンスボディのJSONパースに失敗しました"}}if(typeof s=="object"&&s.url){const a=s.url;return a.includes(r)?{passed:!0}:{passed:!1,error:`エコーされたURL "${a}" に "${r}" が含まれていません`}}else return{passed:!1,error:"レスポンスボディにURL情報が含まれていません"}}catch(s){return{passed:!1,error:`レスポンスボディの解析に失敗しました: ${s}`}}}case"bodyJsonPathEquals":{if(o.length<2)return{passed:!1,error:"bodyJsonPathEquals requires JSONPath and expected value"};const r=o[0],s=o.slice(1).join(" ");try{let a;if(typeof t.body=="string")try{a=JSON.parse(t.body)}catch{return{passed:!1,error:"レスポンスボディが有効なJSONではありません"}}else if(typeof t.bodyText=="string")try{a=JSON.parse(t.bodyText)}catch{return{passed:!1,error:"レスポンスボディが有効なJSONではありません"}}else a=t.body;if(!a)return{passed:!1,error:"レスポンスボディが空です"};const i=S({path:r,json:a});if(!Array.isArray(i)||i.length===0)return{passed:!1,error:`JSONPath "${r}" に一致する値が見つかりません`};const l=i[0],d=String(l),u=String(s);return d!==u?{passed:!1,error:`JSONPath "${r}" の値が期待値と異なります
期待: ${u}
実際: ${d}`}:{passed:!0}}catch(a){return{passed:!1,error:`JSONPath "${r}" の評価中にエラーが発生しました: ${a.message}`}}}default:return{passed:!1,error:`Unknown test command: ${n}`}}}function Wn(e,t){if(!e)return t;const n=e.split(`
`);for(const o of n){const r=o.trim();if(!r||r.startsWith("//"))continue;const s=r.indexOf(" ");if(s===-1){console.warn(`Invalid command format: ${r}`);continue}const a=r.substring(0,s),i=r.substring(s+1).trim();console.log("Executing command:",a,i);try{switch(a){case"setBody":if(!i){v("setBody requires a body content");continue}if(Array.isArray(t.body)&&t.body.some(g=>g.type==="file")||t.bodyType==="binary"&&t.body instanceof File){console.warn("⚠️ setBody: Request contains file data. setBody command will be ignored to preserve file data."),v("setBody command ignored: Request contains file data");continue}t.body=i,!t.headers["Content-Type"]&&!t.headers["content-type"]&&(t.headers["Content-Type"]="application/json");break;case"removeHeader":if(!i){v("removeHeader requires a header name");continue}const l=i.toLowerCase();Object.keys(t.headers).forEach(g=>{g.toLowerCase()===l&&delete t.headers[g]});break;case"setUrl":if(!i){console.warn("setUrl requires a URL");continue}t.url=i;break;case"setUrlWithVar":if(!i){console.warn("setUrlWithVar requires a variable name");continue}const d=K(i);if(d===void 0)throw new Error(`変数「${i}」が変数ではありません`);t.url=d;break;case"addHeader":if(!i){console.warn("addHeader requires a header name and value");continue}const u=i.indexOf(" ");if(u===-1){console.warn("addHeader requires both header name and value");continue}const y=i.substring(0,u),m=i.substring(u+1).trim();t.headers[y]=m;break;case"addHeaderWithVar":if(!i){v("addHeaderWithVar requires a header name and variable name");continue}const p=i.indexOf(" ");if(p===-1){v("addHeaderWithVar requires both header name and variable name");continue}const f=i.substring(0,p),h=i.substring(p+1).trim();try{const g=at(h);t.headers[f]=String(g)}catch(g){v(g.message);continue}break;case"setBodyWithVar":if(!i){v("setBodyWithVar requires a variable name");continue}if(Array.isArray(t.body)&&t.body.some(g=>g.type==="file")||t.bodyType==="binary"&&t.body instanceof File){console.warn("⚠️ setBodyWithVar: Request contains file data. setBodyWithVar command will be ignored to preserve file data."),v("setBodyWithVar command ignored: Request contains file data");continue}try{const g=at(i);t.body=String(g)}catch(g){v(g.message);continue}break;default:console.warn(`Unknown command: ${a}`)}}catch(l){throw console.error("Pre-request script 実行エラー:",l),v(`Pre-request script 実行エラー: ${l.message}`),l}}return t}function ye(e){const t=document.getElementById("response-tests");if(e.length===0){t.innerHTML='<p class="empty-message">No tests executed</p>';return}const n=e.filter(s=>s.passed).length,o=e.filter(s=>!s.passed).length;let r=`<div class="test-summary"><span class="test-passed">✓ ${n} passed</span><span class="test-failed">✗ ${o} failed</span></div><div class="test-results">`;e.forEach(s=>{r+=`<div class="test-result ${s.passed?"passed":"failed"}"><span class="test-icon">${s.passed?"✓":"✗"}</span><span class="test-name">${_(s.name)}</span>${s.error?`<span class="test-error">${_(s.error)}</span>`:""}</div>`}),r+="</div>",t.innerHTML=r}function Kn(e){let t={...e};if(e.bodyType==="binary"&&typeof e.body=="string")try{const r=JSON.parse(e.body);if(r.type==="binaryFile"&&r.base64Data){const s=ae(r.base64Data,r.fileName,r.fileType);t={...e,body:s},console.log("🔍 [processVariables] Binary file restored from Base64:",{name:r.fileName,size:r.fileSize,type:r.fileType})}}catch(r){console.error("🔍 [processVariables] Failed to restore binary file:",r)}const n=Array.isArray(t.body)&&t.body.some(r=>r.type==="file"&&(r.file||r.fileContent))||t.bodyType==="binary"&&t.body instanceof File;let o;if(n?(console.log("🔍 [processVariables] File objects detected, using manual clone"),o={...t,headers:{...t.headers},params:{...t.params},auth:{...t.auth},body:Array.isArray(t.body)?t.body.map(r=>{if(r.type==="file"&&r.fileContent&&!r.file)try{const s=ae(r.fileContent,r.fileName,r.fileType);return{...r,file:s}}catch(s){return console.error("Failed to restore file from base64:",s),r}return r}):t.body}):(console.log("🔍 [processVariables] No file objects, using JSON clone"),o=JSON.parse(JSON.stringify(t))),o.url=j(o.url),!o.url||!o.url.trim())throw new Error("URL is required");try{const r=new URL(o.url);switch(o.params=me(o.params),Object.entries(o.params).forEach(([s,a])=>{r.searchParams.set(s,String(a))}),o.auth.type==="apikey"&&o.auth.addTo==="query"&&o.auth.key&&o.auth.value&&r.searchParams.set(o.auth.key,o.auth.value),o.url=r.toString(),o.headers=me(o.headers),o.auth.type){case"basic":o.auth.username&&(o.auth.username=j(o.auth.username)),o.auth.password&&(o.auth.password=j(o.auth.password));break;case"bearer":o.auth.token&&(o.auth.token=j(o.auth.token));break;case"apikey":o.auth.key&&(o.auth.key=j(o.auth.key)),o.auth.value&&(o.auth.value=j(o.auth.value));break}o.body&&(typeof o.body=="string"?o.body=j(o.body):n?(console.log("🔍 [processVariables] Skipping variable replacement for body with files"),Array.isArray(o.body)&&(o.body=o.body.map(s=>s.type==="file"?s:{...s,value:s.value?j(s.value):s.value}))):o.body=me(o.body))}catch{throw new Error(`Invalid URL: ${o.url}`)}return o}async function Gn(e,t,n=[]){await kn(e,t,n)}async function Xn(){const e=c.currentRequest;if(!e||!e.id){v("No request to save.");return}try{const t=document.getElementById("methodSelect"),n=document.getElementById("nameInput"),o=document.getElementById("urlInput");e.method=t.value,e.name=n.value.trim(),e.url=o.value.trim();const r=document.querySelectorAll("#headersContainer .key-value-row"),s={};r.forEach(m=>{const p=m,f=p.querySelector(".key-input"),h=p.querySelector(".value-input"),g=f.value.trim(),b=h.value.trim();g&&(s[g]=b)}),e.headers=s;const a=document.querySelectorAll("#paramsContainer .key-value-row");console.log("saveCurrentRequest: Found param rows:",a.length);const i={};a.forEach((m,p)=>{const f=m,h=f.querySelector(".key-input"),g=f.querySelector(".value-input"),b=h.value.trim(),F=g.value.trim();console.log(`saveCurrentRequest: Row ${p}: ${b} = ${F}`),b&&(i[b]=F)}),console.log("saveCurrentRequest: New params object:",i),e.params=i;const l=document.querySelector('input[name="bodyType"]:checked');switch(e.bodyType=l.value,e.bodyType){case"raw":e.body=document.getElementById("rawBody").value;break;case"json":e.body=document.getElementById("jsonBody").value;break;case"form-data":e.body=await Ot("formDataFieldsContainer");break;case"urlencoded":e.body=Q("urlEncodedContainer");break;case"binary":const m=await Pt("binaryFileInput");e.body=m;break;default:e.body=null}const d=document.getElementById("authType");if(e.auth={type:d.value},d.value==="basic"){const m=document.getElementById("authUsername"),p=document.getElementById("authPassword");e.auth.username=m.value,e.auth.password=p.value}else if(d.value==="bearer"){const m=document.getElementById("authToken");e.auth.token=m.value}else if(d.value==="apikey"){const m=document.getElementById("authKey"),p=document.getElementById("authValue"),f=document.getElementById("authAddTo");e.auth.key=m.value,e.auth.value=p.value,e.auth.addTo=f.value}const u=document.getElementById("preRequestScript"),y=document.getElementById("testScript");if(e.preRequestScript=(u==null?void 0:u.value)||"",e.testScript=(y==null?void 0:y.value)||"",console.log("保存するリクエスト:",e),console.log("保存するテストスクリプト:",e.testScript),c.currentCollection){const m=c.collections.find(p=>p.id===c.currentCollection);if(m&&m.requests){const p=m.requests.findIndex(f=>f.id===e.id);if(p!==-1){m.requests[p]=JSON.parse(JSON.stringify(e)),await P(),w("Request saved to collection.");return}}}if(c.currentScenario){const m=c.scenarios.find(p=>p.id===c.currentScenario);if(m&&m.requests){const p=m.requests.findIndex(f=>f.id===e.id);if(p!==-1){m.requests[p]=JSON.parse(JSON.stringify(e)),await A(),w("Request saved to scenario.");return}}}w("Request saved.")}catch(t){console.error("Error saving request:",t),v("Failed to save request: "+t.message)}}function at(e){console.log("🔍 [getValueFromVarString] Processing variable string:",e);try{const t=K(e);if(t===void 0)throw new Error(`変数「${e}」が見つかりません`);return console.log("🔍 [getValueFromVarString] Resolved value:",t),t}catch(t){throw console.error("🔍 [getValueFromVarString] Error resolving variable:",t),new Error(`変数解析エラー: ${t.message}`)}}async function ht(){try{const e=await chrome.storage.local.get(["scenarios"]);!e.scenarios||e.scenarios.length===0?(c.scenarios.splice(0,c.scenarios.length,...Wt),await chrome.storage.local.set({scenarios:c.scenarios})):c.scenarios.splice(0,c.scenarios.length,...e.scenarios),ee();const{renderScenariosTree:t}=await ie(async()=>{const{renderScenariosTree:n}=await Promise.resolve().then(()=>We);return{renderScenariosTree:n}},void 0);t()}catch(e){console.error("Error initializing scenarios:",e)}}function ee(){const e=document.getElementById("scenarioList");e.innerHTML="",c.scenarios.forEach(t=>{const n=document.createElement("li");n.textContent=t.name,n.dataset.id=t.id,c.currentScenario===t.id&&n.classList.add("active"),n.addEventListener("click",()=>ze(t.id)),e.appendChild(n)})}function ze(e){c.currentScenario=e,ee();const t=c.scenarios.find(r=>r.id===e),n=document.getElementById("scenarioTitle");n.textContent=t?t.name:"",ce(e);const o=document.getElementById("runScenarioBtn");o.disabled=!1}async function gt(e,t){const n=c.scenarios.find(a=>a.id===e);if(!n){v("Scenario not found.");return}const o=prompt("Insert request ID from any collection:");if(!o)return;let r=null;for(const a of c.collections){if(!a.requests)continue;const i=a.requests.find(l=>String(l.id)===o);if(i){r=i;break}}if(!r){v("Request ID not found in any collection.");return}const s=JSON.parse(JSON.stringify(r));s.id=`req_${Date.now()}_${Math.random().toString(36).substring(2)}`,n.requests.splice(t,0,s),await A(),w(`Inserted "${s.name}" at position ${t+1}`),ce(e)}function ce(e){const t=document.getElementById("scenarioRequestsList");t.innerHTML="";const n=c.scenarios.find(o=>o.id===e);if(!n||!n.requests.length){const o=document.createElement("li");o.textContent="No requests in this scenario.",t.appendChild(o);return}n.requests.forEach((o,r)=>{const s=document.createElement("li");s.className="scenario-request-item";const a=document.createElement("span");a.className="req-name",a.textContent=o.name||"Untitled Request",s.appendChild(a);const i=document.createElement("button");i.textContent="Load",i.title="Load this request into editor",i.addEventListener("click",()=>{const m=c.scenarios.find(p=>p.id===c.currentScenario);if(m&&m.requests){const p=m.requests.findIndex(f=>f.id===o.id);p!==-1&&G(m.requests[p])}}),s.appendChild(i);const l=document.createElement("button");l.textContent="↑",l.title="Move up",l.disabled=r===0,l.addEventListener("click",()=>{it(e,r,r-1)}),s.appendChild(l);const d=document.createElement("button");d.textContent="↓",d.title="Move down",d.disabled=r===n.requests.length-1,d.addEventListener("click",()=>{it(e,r,r+1)}),s.appendChild(d);const u=document.createElement("button");u.textContent="+",u.title="Insert a request here",u.addEventListener("click",()=>{gt(e,r)}),s.appendChild(u);const y=document.createElement("button");y.textContent="×",y.title="Delete this request",y.addEventListener("click",()=>{Yn(e,r)}),s.appendChild(y),t.appendChild(s)})}async function it(e,t,n){const o=c.scenarios.find(s=>s.id===e);if(!o)return;const[r]=o.requests.splice(t,1);o.requests.splice(n,0,r),await A(),ce(e)}async function Yn(e,t){const n=c.scenarios.find(o=>o.id===e);n&&(n.requests.splice(t,1),await A(),ce(e))}async function bt(){const e=prompt("Enter scenario name:");if(!e)return;const t=`scenario_${Date.now()}_${Math.random().toString(36).substring(2)}`,n={id:t,name:e,requests:[]};c.scenarios.push(n),await A(),ze(t),ee()}async function Qn(){const e=prompt("Enter scenario name:");if(!e)return;const t={id:`scenario_${Date.now()}`,name:e,requests:[]};c.scenarios.push(t),await A(),ee();const{renderScenariosTree:n}=await ie(async()=>{const{renderScenariosTree:o}=await Promise.resolve().then(()=>We);return{renderScenariosTree:o}},void 0);n(),w("Scenario created: "+e)}async function vt(e){if(!c.currentScenario){v("Please select a scenario first.");return}const t=c.scenarios.find(r=>r.id===c.currentScenario);if(!t)return;const n=JSON.parse(JSON.stringify(e));n.id=`req_${Date.now()}_${Math.random().toString(36).substring(2)}`,t.requests.push(n),await A(),ce(c.currentScenario);const{renderScenariosTree:o}=await ie(async()=>{const{renderScenariosTree:r}=await Promise.resolve().then(()=>We);return{renderScenariosTree:r}},void 0);o()}async function Et(){if(!c.currentScenario){v("No scenario selected.");return}const e=c.scenarios.find(n=>n.id===c.currentScenario);if(!e||!e.requests.length){v("Scenario has no requests.");return}const t=document.getElementById("scenarioResultContainer");t.innerHTML="";for(let n=0;n<e.requests.length;n++){const o=e.requests[n],r=document.createElement("div");r.className="result-item",r.textContent=`Executing ${n+1}/${e.requests.length}: ${o.name}`,t.appendChild(r);try{const s=await ft(o,!0);if(typeof s=="string"){r.textContent=`[${n+1}] ${o.name} → ERROR: ${s}`;continue}if("response"in s&&"testResults"in s){const{response:a,testResults:i}=s;r.textContent=`[${n+1}] ${o.name} → ${a.status} ${a.statusText}`;const l=document.createElement("pre");if(l.textContent=a.bodyText,l.style.maxHeight="200px",l.style.overflow="auto",r.appendChild(l),i&&i.length>0){const d=document.createElement("div");d.style.marginTop="8px";const u=i.filter(m=>m.passed).length,y=i.filter(m=>!m.passed).length;if(d.innerHTML=`<strong>Tests: ${u} passed, ${y} failed</strong>`,y>0){const m=i.filter(f=>!f.passed),p=document.createElement("ul");p.style.color="#dc3545",p.style.fontSize="12px",m.forEach(f=>{const h=document.createElement("li");h.textContent=`${f.name}: ${f.error||"Failed"}`,p.appendChild(h)}),d.appendChild(p)}r.appendChild(d)}}else r.textContent=`[${n+1}] ${o.name} → ${s.status} ${s.statusText}`}catch(s){r.textContent=`[${n+1}] ${o.name} → ERROR: ${s.message}`}}w("Scenario execution completed.")}const Zn=Object.freeze(Object.defineProperty({__proto__:null,addRequestToScenario:vt,createNewScenario:Qn,initializeScenarios:ht,insertRequestIntoScenario:gt,newScenario:bt,renderScenarioList:ee,renderScenarioRequests:ce,runScenario:Et,selectScenario:ze},Symbol.toStringTag,{value:"Module"}));async function wt(){try{const e=await chrome.storage.local.get(["collections"]);!e.collections||e.collections.length===0?(c.collections.splice(0,c.collections.length,...Jt),await chrome.storage.local.set({collections:c.collections})):c.collections.splice(0,c.collections.length,...e.collections),O(),le(),z()}catch(e){console.error("Error initializing collections:",e)}}async function St(e){c.currentCollection=e,await Ze(),document.querySelectorAll(".collection-item").forEach(n=>{const o=n;o.classList.toggle("active",o.dataset.id==e)});const t=document.getElementById("collectionVarSelect");t&&(t.value=e,N("collection"))}function Ue(){return`req_${Date.now()}_${Math.random().toString(36).substring(2)}`}async function Tt(e){const t=c.collections.find(r=>r.id===e);if(!t)return;const n=prompt("リクエスト名を入力してください:");if(!n)return;const o={id:Ue(),name:n,method:"GET",url:"",headers:{},params:{},body:null,auth:{type:"none"},preRequestScript:"",bodyType:"none"};t.requests.push(o),await P(),O(),c.currentRequest=o,G(o)}async function Ft(e){const t=c.collections.find(n=>{var o;return(o=n.requests)==null?void 0:o.some(r=>r.id===e.id)});if(t){await St(t.id);const n=t.requests.find(o=>o.id===e.id);if(n){console.log("Loading latest request data:",n),G(n),w("Request loaded from collection");return}}G(e),w("Request loaded from collection")}function kt(){const e=prompt("Enter collection name:");if(!e)return;const t={id:Date.now().toString(),name:e,requests:[]};c.collections.push(t),chrome.storage.local.set({collections:c.collections}),O(),z(),w("Collection created: "+e)}async function eo(e){if(!confirm("本当にこのコレクションを削除しますか？"))return;const t=c.collections.findIndex(n=>n.id==e);t!==-1&&(c.collections.splice(t,1),await P(),c.currentCollection==e&&(c.currentCollection=null,await Ze()),O(),w("コレクションを削除しました"))}async function to(e,t){if(!confirm("本当にこのリクエストを削除しますか？"))return;const n=c.collections.find(o=>o.id==e);!n||!n.requests||!n.requests.some(o=>o.id===t)||(n.requests=n.requests.filter(o=>o.id!==t),await P(),O(),w("リクエストを削除しました"))}function O(){const e=document.getElementById("collectionsTree");e&&(e.innerHTML="",c.collections.forEach(t=>{var d;const n=document.createElement("div");n.className="collection-item",n.dataset.id=t.id;const o=document.createElement("span");o.className="toggle-icon",o.textContent="▶",n.appendChild(o);const r=document.createElement("span");r.className="collection-icon",r.textContent="📁",n.appendChild(r);const s=document.createElement("span");s.className="collection-name",s.textContent=t.name,n.appendChild(s);const a=document.createElement("span");a.className="menu-btn",a.textContent="⋮",a.addEventListener("click",u=>{u.stopPropagation();const y=a.getBoundingClientRect();ke(y.left,y.top,[{text:"リクエストを追加",icon:"🌱",action:()=>Tt(t.id)},{text:"コレクションを削除",icon:"🗑️",action:()=>eo(t.id)}])}),n.appendChild(a),e.appendChild(n);const i=document.createElement("ul");i.className="request-list";const l=((d=c.sidebarState)==null?void 0:d.expandedCollections.has(t.id))||!1;if(i.style.display=l?"block":"none",l&&(o.textContent="▼"),t.requests&&t.requests.length>0)t.requests.forEach(u=>{const y=document.createElement("li");y.className="request-item",y.innerHTML=`
                    <span class="method-badge method-${u.method}">${u.method}</span>
                    <span class="request-name">${u.name}</span>
                    <span class="menu-btn">⋮</span>
                `,y.addEventListener("click",p=>{p.target.classList.contains("menu-btn")||(p.stopPropagation(),Ft(u))});const m=y.querySelector(".menu-btn");m==null||m.addEventListener("click",p=>{p.stopPropagation();const f=p.target.getBoundingClientRect();ke(f.left,f.top,[{text:"リクエストをコピー",icon:"📋",action:()=>ro(u,t.id)},{text:"リクエストを移動",icon:"📁",action:()=>ao(u,t.id)},{text:"シナリオに追加",icon:"🌱",action:()=>vt(u)},{text:"リクエストを削除",icon:"🗑️",action:()=>to(t.id,u.id)}])}),i.appendChild(y)});else{const u=document.createElement("li");u.className="request-item empty-message",u.textContent="No requests",i.appendChild(u)}e.appendChild(i),n.addEventListener("click",async()=>{var u,y;if(i.style.display==="none"){i.style.display="block",o.textContent="▼",(u=c.sidebarState)==null||u.expandedCollections.add(t.id),await xe(),document.querySelectorAll(".collection-item").forEach(p=>{const f=p;f.classList.toggle("active",f.dataset.id==t.id)}),c.currentCollection=t.id,Ze();const m=document.getElementById("collectionVarSelect");m&&(m.value=t.id,N("collection"))}else i.style.display="none",o.textContent="▶",(y=c.sidebarState)==null||y.expandedCollections.delete(t.id),await xe()})}))}function le(){const e=document.getElementById("scenariosTree");e&&(e.innerHTML="",c.scenarios.forEach(t=>{var d;const n=document.createElement("div");n.className="scenario-item",n.dataset.id=t.id;const o=document.createElement("span");o.className="toggle-icon",o.textContent="▶",n.appendChild(o);const r=document.createElement("span");r.className="scenario-icon",r.textContent="🎬",n.appendChild(r);const s=document.createElement("span");s.className="scenario-name",s.textContent=t.name,n.appendChild(s);const a=document.createElement("span");a.className="menu-btn",a.textContent="⋮",a.addEventListener("click",u=>{u.stopPropagation();const y=a.getBoundingClientRect();ke(y.left,y.top,[{text:"シナリオを編集",icon:"✏️",action:()=>{c.currentScenario=t.id,Ce(),ve("scenarios")}},{text:"シナリオを削除",icon:"🗑️",action:()=>no(t.id)}])}),n.appendChild(a),e.appendChild(n);const i=document.createElement("ul");i.className="request-list";const l=((d=c.sidebarState)==null?void 0:d.expandedScenarios.has(t.id))||!1;if(i.style.display=l?"block":"none",l&&(o.textContent="▼"),t.requests&&t.requests.length>0)t.requests.forEach(u=>{const y=document.createElement("li");y.className="request-item",y.innerHTML=`
                    <span class="method-badge method-${u.method}">${u.method}</span>
                    <span class="request-name">${u.name}</span>
                    <span class="menu-btn">⋮</span>
                `,y.addEventListener("click",p=>{p.target.classList.contains("menu-btn")||(p.stopPropagation(),ct(u,t.id))});const m=y.querySelector(".menu-btn");m==null||m.addEventListener("click",p=>{p.stopPropagation();const f=p.target.getBoundingClientRect();ke(f.left,f.top,[{text:"リクエストをコピー",icon:"📋",action:()=>so(u,t.id)},{text:"リクエストを移動",icon:"📁",action:()=>io(u,t.id)},{text:"リクエストを編集",icon:"✏️",action:()=>ct(u,t.id)},{text:"シナリオから削除",icon:"🗑️",action:()=>oo(t.id,u.id)}])}),i.appendChild(y)});else{const u=document.createElement("li");u.className="request-item empty-message",u.textContent="No requests",i.appendChild(u)}e.appendChild(i),n.addEventListener("click",async()=>{var u,y;i.style.display==="none"?(i.style.display="block",o.textContent="▼",(u=c.sidebarState)==null||u.expandedScenarios.add(t.id),await xe(),document.querySelectorAll(".scenario-item").forEach(m=>{const p=m;p.classList.toggle("active",p.dataset.id==t.id)}),c.currentScenario=t.id,Ce()):(i.style.display="none",o.textContent="▶",(y=c.sidebarState)==null||y.expandedScenarios.delete(t.id),await xe())})}))}async function ct(e,t){c.currentScenario=t,await Ce();const n=c.scenarios.find(o=>o.id===t);if(n&&n.requests){const o=n.requests.find(r=>r.id===e.id);if(o){console.log("Loading latest scenario request data:",o),G(o),w("Request loaded from scenario");return}}G(e),w("Request loaded from scenario")}async function no(e){if(!confirm("本当にこのシナリオを削除しますか？"))return;const t=c.scenarios.findIndex(n=>n.id==e);t!==-1&&(c.scenarios.splice(t,1),await A(),c.currentScenario==e&&(c.currentScenario=null,await Ce()),le(),w("シナリオを削除しました"))}async function oo(e,t){if(!confirm("本当にこのリクエストをシナリオから削除しますか？"))return;const n=c.scenarios.find(o=>o.id==e);!n||!n.requests||!n.requests.some(o=>o.id===t)||(n.requests=n.requests.filter(o=>o.id!==t),await A(),le(),w("リクエストをシナリオから削除しました"))}function ke(e,t,n){const o=document.querySelector(".context-menu");o&&o.remove();const r=document.createElement("div");r.className="context-menu",r.style.position="fixed",r.style.left=`${e}px`,r.style.top=`${t}px`,n.forEach(a=>{const i=document.createElement("div");i.className="context-menu-item",i.innerHTML=`<span class="menu-icon">${a.icon}</span>${a.text}`,i.addEventListener("click",()=>{a.action(),r.remove()}),r.appendChild(i)}),document.body.appendChild(r);const s=a=>{r.contains(a.target)||(r.remove(),document.removeEventListener("click",s))};document.addEventListener("click",s)}async function ro(e,t){const n=c.collections.find(r=>r.id===t);if(!n)return;const o={...JSON.parse(JSON.stringify(e)),id:Ue(),name:`${e.name} (Copy)`};delete o.lastRequestExecution,delete o.lastResponseExecution,n.requests.push(o),await P(),O(),w(`"${e.name}" をコピーしました`)}async function so(e,t){const n=c.scenarios.find(r=>r.id===t);if(!n)return;const o={...JSON.parse(JSON.stringify(e)),id:Ue(),name:`${e.name} (Copy)`};delete o.lastRequestExecution,delete o.lastResponseExecution,n.requests.push(o),await A(),le(),w(`"${e.name}" をシナリオ内でコピーしました`)}async function ao(e,t){const n=c.collections.filter(l=>l.id!==t);if(n.length===0){v("移動先のコレクションがありません。");return}const o=n.map(l=>l.name),r=prompt(`"${e.name}" を移動するコレクションを選択してください:

${o.map((l,d)=>`${d+1}. ${l}`).join(`
`)}

番号を入力してください:`);if(!r)return;const s=parseInt(r,10)-1;if(isNaN(s)||s<0||s>=n.length){v("無効な番号です");return}const a=n[s],i=c.collections.find(l=>l.id===t);i&&(i.requests=i.requests.filter(l=>l.id!==e.id),a.requests.push(e),await P(),O(),w(`"${e.name}" を "${a.name}" に移動しました`))}async function io(e,t){const n=c.scenarios.filter(l=>l.id!==t);if(n.length===0){v("移動先のシナリオがありません。");return}const o=n.map(l=>l.name),r=prompt(`"${e.name}" を移動するシナリオを選択してください:

${o.map((l,d)=>`${d+1}. ${l}`).join(`
`)}

番号を入力してください:`);if(!r)return;const s=parseInt(r,10)-1;if(isNaN(s)||s<0||s>=n.length){v("無効な番号です");return}const a=n[s],i=c.scenarios.find(l=>l.id===t);i&&(i.requests=i.requests.filter(l=>l.id!==e.id),a.requests.push(e),await A(),le(),w(`"${e.name}" を "${a.name}" に移動しました`))}const We=Object.freeze(Object.defineProperty({__proto__:null,addRequestToCollection:Tt,createNewCollection:kt,initializeCollections:wt,loadCollectionRequest:Ft,renderCollectionsTree:O,renderScenariosTree:le,selectCollection:St},Symbol.toStringTag,{value:"Module"}));let qe=!1;function co(){if(qe)return;const e=uo();chrome.runtime.sendMessage({action:"startInterceptor",filters:e},t=>{if(t!=null&&t.success){qe=!0;const n=document.getElementById("startInterceptorBtn"),o=document.getElementById("stopInterceptorBtn");n.disabled=!0,o.disabled=!1,w("Interceptor started")}}),chrome.runtime.onMessage.addListener(qt)}function lo(){qe&&(chrome.runtime.sendMessage({action:"stopInterceptor"},e=>{if(e!=null&&e.success){qe=!1;const t=document.getElementById("startInterceptorBtn"),n=document.getElementById("stopInterceptorBtn");t.disabled=!1,n.disabled=!0,w("Interceptor stopped")}}),chrome.runtime.onMessage.removeListener(qt))}function uo(){const e=[];document.querySelectorAll(".method-filters input:checked").forEach(o=>{const r=o;e.push(r.value)});const n=document.getElementById("domainFilter").value.trim();return{methods:e,domain:n}}function qt(e){e.action==="requestIntercepted"&&e.request&&po(e.request)}function po(e){const t=document.getElementById("interceptorContainer"),n=document.createElement("div");for(n.className="intercepted-request",n.innerHTML=`
        <span class="history-method method-${e.method}">${e.method}</span>
        <span class="history-url">${_(e.url)}</span>
        <span class="history-status status-${(e.status||0)<400?"success":"error"}">${e.status||"Pending"}</span>
        <span class="history-time">${new Date().toLocaleTimeString()}</span>
    `,n.addEventListener("click",()=>{yo(e)}),t.insertBefore(n,t.firstChild);t.children.length>50;){const o=t.lastChild;o&&t.removeChild(o)}}async function yo(e){const t={id:`intercepted_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:`Intercepted ${e.method} Request`,method:e.method,url:e.url,headers:e.headers||{},params:{},body:e.body||null,bodyType:"none",auth:{type:"none"},preRequestScript:""};G(t),w("Request loaded from interceptor")}function mo(){const e=document.getElementById("testScript");e&&!e.value.trim()&&(e.value=Ut)}function fo(){const e=document.getElementById("importExportModal"),t=document.getElementById("modalTitle");e.classList.add("active"),t.textContent="Import Data"}function lt(e){var r;const n=(r=e.target.files)==null?void 0:r[0];if(!n)return;const o=new FileReader;o.onload=function(s){var i;const a=document.getElementById("importText");a.value=(i=s.target)==null?void 0:i.result},o.readAsText(n)}async function ho(){const e=document.getElementById("importType"),t=document.getElementById("importText"),n=e.value,o=t.value.trim();if(!o){v("Please select a file or paste content to import");return}try{let r;try{r=JSON.parse(o)}catch{if(n==="curl")r=Fo(o);else throw new Error("Invalid JSON format")}switch(n){case"postman":await bo(r);break;case"apitester":await Eo(r);break;case"openapi":await So(r);break;case"har":await To(r);break;case"curl":ko(r);break;case"talentedapitester":await vo(r);break}document.getElementById("importExportModal").classList.remove("active"),w("Import completed successfully")}catch(r){v("Import failed: "+r.message)}}function go(e){var n,o,r;const t={type:e.type||"none"};switch(e.type){case"basic":const s=(n=e.basic)==null?void 0:n.reduce((l,d)=>(l[d.key]=d.value,l),{});t.username=(s==null?void 0:s.username)||"",t.password=(s==null?void 0:s.password)||"";break;case"bearer":const a=(o=e.bearer)==null?void 0:o.reduce((l,d)=>(l[d.key]=d.value,l),{});t.token=(a==null?void 0:a.token)||"";break;case"apikey":const i=(r=e.apikey)==null?void 0:r.reduce((l,d)=>(l[d.key]=d.value,l),{});t.key=(i==null?void 0:i.key)||"",t.value=(i==null?void 0:i.value)||"",t.addTo=(i==null?void 0:i.in)==="query"?"query":"header";break}return t}function Bt(e,t=""){const n=[];return e.forEach(o=>{var r,s;if(o.request){const a={id:`req_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:o.name||"Untitled Request",method:o.request.method||"GET",url:typeof o.request.url=="string"?o.request.url:((r=o.request.url)==null?void 0:r.raw)||"",headers:{},params:{},body:null,bodyType:"none",auth:{type:"none"},preRequestScript:""};if(o.request.header&&o.request.header.forEach(i=>{i.disabled||(a.headers[i.key]=i.value)}),typeof o.request.url=="object"&&o.request.url.query&&o.request.url.query.forEach(i=>{i.disabled||(a.params[i.key]=i.value)}),o.request.body)switch(o.request.body.mode){case"raw":a.body=o.request.body.raw||null;break;case"formdata":const i={};(s=o.request.body.formdata)==null||s.forEach(l=>{l.disabled||(i[l.key]=l.value)}),a.body=i;break}o.request.auth&&(a.auth=go(o.request.auth)),n.push(a)}else if(o.item){const a=t?`${t}/${o.name}`:o.name||"";n.push(...Bt(o.item,a))}}),n}async function bo(e){var n;const t={id:`collection_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:((n=e.info)==null?void 0:n.name)||"Imported Collection",requests:[]};e.item&&(t.requests=Bt(e.item)),e.variable&&(e.variable.forEach(o=>{o.key&&!o.disabled&&(c.variables.global[o.key]={value:o.value||"",description:o.description||""})}),await Z()),c.collections.push(t),await P(),z(),O()}async function vo(e){const t=e.entities.find(i=>i.entity.type==="Project");if(!t)throw new Error("Talend JSON に Project が見つかりません");const n=t.children||[],o=[],r=[],s=[];n.forEach(i=>{const{entity:l,children:d}=i;if(l.type==="Service"){const u=l,y=(d||[]).filter(m=>m.entity.type==="Request").map(m=>{var f,h;const p=m.entity;return{id:p.id,name:p.name,method:((f=p.method)==null?void 0:f.name)||"GET",url:((h=p.uri)==null?void 0:h.path)||"",headers:(p.headers||[]).filter(g=>g.enabled).reduce((g,b)=>(g[b.name]=b.value,g),{}),params:{},body:p.body&&p.body.textBody||null,bodyType:"none",auth:{type:"none"},preRequestScript:""}});o.push({id:u.id,name:u.name,requests:y})}else if(l.type==="Scenario"){const u=l,y=(d||[]).filter(m=>m.entity.type==="Request").map(m=>{var f,h;const p=m.entity;return{id:p.id,name:p.name,method:((f=p.method)==null?void 0:f.name)||"GET",url:((h=p.uri)==null?void 0:h.path)||"",headers:(p.headers||[]).filter(g=>g.enabled).reduce((g,b)=>(g[b.name]=b.value,g),{}),params:{},body:p.body&&p.body.textBody||null,bodyType:"none",auth:{type:"none"},preRequestScript:""}});r.push({id:u.id,name:u.name,requests:y})}}),(e.environments||[]).forEach(i=>{const l=i,d={};Object.values(l.variables||{}).forEach(u=>{u.enabled&&(d[u.name]={value:u.value,description:""})}),s.push({id:l.id,name:l.name,variables:d,created:new Date().toISOString()})}),o.length>0&&(c.collections.push(...o),await P()),Array.isArray(c.scenarios)||(c.scenarios=[]),r.length>0&&(c.scenarios.push(...r),await A()),Array.isArray(c.environments)||(c.environments=[]),c.variables.environment||(c.variables.environment={});for(const i of s)c.environments.push({id:i.id,name:i.name,variables:{...i.variables},created:i.created}),c.variables.environment[i.id]=i.variables,await chrome.storage.local.set({[`env_${i.id}`]:i.variables});s.length>0&&(await Re(),await Z()),z(),Ee(),Xe(),O(),ee()}async function Eo(e){e.collections&&c.collections.push(...e.collections),e.variables&&(Object.assign(c.variables.global,e.variables.global||{}),Object.assign(c.variables.collection,e.variables.collection||{})),e.environments&&c.environments.push(...e.environments),await P(),await Z(),await Re(),Ee(),z(),Xe(),O()}function wo(e){return e.servers&&e.servers.length>0?e.servers[0].url:""}async function So(e){var o;const t={id:`collection_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:((o=e.info)==null?void 0:o.title)||"OpenAPI Import",requests:[]},n=wo(e);e.paths&&Object.entries(e.paths).forEach(([r,s])=>{Object.entries(s).forEach(([a,i])=>{var l,d;if(["get","post","put","delete","patch","head","options"].includes(a)){const u={id:`req_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:i.summary||`${a.toUpperCase()} ${r}`,method:a.toUpperCase(),url:n+r,headers:{},params:{},body:null,bodyType:"none",auth:{type:"none"},preRequestScript:""};if(i.parameters&&i.parameters.forEach(y=>{y.in==="query"?u.params[y.name]=y.example||"":y.in==="header"&&(u.headers[y.name]=y.example||"")}),(l=i.requestBody)!=null&&l.content){const y=i.requestBody.content["application/json"];y!=null&&y.example?u.body=JSON.stringify(y.example,null,2):(d=y==null?void 0:y.schema)!=null&&d.example&&(u.body=JSON.stringify(y.schema.example,null,2))}t.requests.push(u)}})}),c.collections.push(t),await P(),z(),O()}async function To(e){const t={id:`collection_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:"HAR Import - "+new Date().toLocaleString(),requests:[]};e.log&&e.log.entries&&e.log.entries.forEach(n=>{const o=n.request;if(o){const r={id:`req_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:`${o.method} ${new URL(o.url).pathname}`,method:o.method,url:o.url,headers:{},params:{},body:null,bodyType:"none",auth:{type:"none"},preRequestScript:""};o.headers&&o.headers.forEach(s=>{r.headers[s.name]=s.value}),o.queryString&&o.queryString.forEach(s=>{r.params[s.name]=s.value}),o.postData&&(r.body=o.postData.text||null),t.requests.push(r)}}),c.collections.push(t),await P(),z(),O()}function Fo(e){const t={id:`curl_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:"Curl Import",method:"GET",url:"",headers:{},params:{},body:null,bodyType:"none",auth:{type:"none"},preRequestScript:""},n=e.replace(/\\\n/g," ").replace(/\s+/g," ").trim(),o=n.match(/curl\s+(?:'([^']+)'|"([^"]+)"|(\S+))/);o&&(t.url=o[1]||o[2]||o[3]);const r=n.match(/-X\s+(\w+)/);r&&(t.method=r[1].toUpperCase());const s=/-H\s+(?:'([^']+)'|"([^"]+)")/g;let a;for(;a=s.exec(n);){const d=a[1]||a[2],[u,...y]=d.split(":");u&&y.length&&(t.headers[u.trim()]=y.join(":").trim())}const i=n.match(/(?:-d|--data)\s+(?:'([^']+)'|"([^"]+)"|(\S+))/);i&&(t.body=i[1]||i[2]||i[3]);const l=n.match(/-u\s+(?:'([^']+)'|"([^"]+)"|(\S+))/);if(l){const d=l[1]||l[2]||l[3],[u,y]=d.split(":");u&&(t.auth={type:"basic",username:u,password:y||""})}return t}function ko(e){c.currentRequest||(c.currentRequest={id:"",name:"",method:"GET",url:"",headers:{},params:{},body:null,bodyType:"none",auth:{type:"none"},preRequestScript:""}),c.currentRequest.method=e.method,c.currentRequest.url=e.url,c.currentRequest.headers={...e.headers},c.currentRequest.params={},c.currentRequest.body=e.body||null,c.currentRequest.auth=e.auth||{type:"none"};const t=document.getElementById("headersContainer");if(t.innerHTML="",Object.entries(e.headers).forEach(([o,r])=>{x(t,"header");const s=t.querySelectorAll(".key-value-row"),a=s[s.length-1],i=a.querySelector(".key-input"),l=a.querySelector(".value-input");i.value=o,l.value=r}),Object.keys(e.headers).length===0&&x(t,"header"),e.body){const o=document.querySelector('input[name="bodyType"][value="raw"]');o.checked=!0,V({target:{value:"raw"}});const r=document.getElementById("rawBody");r.value=e.body.toString()}if(e.auth&&e.auth.type!=="none"){const o=document.getElementById("authType");o.value=e.auth.type,$e(e.auth.type),ge()}document.getElementById("importExportModal").classList.remove("active")}async function qo(){const e={version:"1.0",exportDate:new Date().toISOString(),collections:c.collections,variables:{global:c.variables.global,collection:c.variables.collection},environments:c.environments,currentEnvironment:c.currentEnvironment,history:c.history.slice(0,50)},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=`api-tester-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),w("Data exported successfully")}function _(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function J(e){if(e===0)return"0 B";const t=1024,n=["B","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,o)).toFixed(2))+" "+n[o]}function Ke(e,t="info"){const n=document.getElementById("notificationArea");if(!n)return;const o=document.createElement("div");o.className=`notification notification-${t}`,o.textContent=e,n.appendChild(o),setTimeout(()=>{o.classList.add("fade-out"),setTimeout(()=>o.remove(),300)},3e3)}function w(e){Ke(e,"success")}function v(e,t){const n=t?`${e}

Details: ${t}`:e;Ke(n,"error")}function Ct(e,t){let n="Network request failed: ";t.name==="TypeError"&&t.message.includes("fetch")?n+="Unable to connect to the server. Please check your internet connection and verify the URL is correct.":t.message.includes("CORS")?n+="Cross-origin request blocked. The server may not allow requests from this browser extension.":t.message.includes("timeout")?n+="Request timed out. The server may be slow or unreachable.":t.message.includes("SSL")||t.message.includes("certificate")?n+="SSL/TLS error. The server certificate may be invalid or expired.":n+=t.message||"Unknown network error occurred.",v(n,`URL: ${e}
Error Type: ${t.name||"Unknown"}`)}function Be(e,t){let n="Variable resolution failed: ";t.message.includes("not found")||t.message.includes("見つかりません")?n+=`Variable "${e}" was not found. Please check the variable name and ensure it exists in your environment, global, or collection variables.`:t.message.includes("JSONPath")?n+=`JSONPath expression error in "${e}". Please verify your JSONPath syntax.`:t.message.includes("構文が不正")?n+=`Invalid variable syntax in "${e}". Please check the format: \${"scenarios"."Name"."Request"."response"."property"}`:n+=t.message||"Unknown variable error occurred.",v(n,`Variable: ${e}`)}function xt(e,t){let n="File operation failed: ";t.message.includes("too large")||t.message.includes("size")?n+=`File "${e}" is too large. Maximum file size is 10MB.`:t.message.includes("type")||t.message.includes("format")?n+=`File "${e}" has an unsupported format or is corrupted.`:t.message.includes("read")?n+=`Unable to read file "${e}". The file may be corrupted or in use by another application.`:n+=t.message||"Unknown file error occurred.",v(n,`File: ${e}`)}function Bo(e,t){let n="Storage operation failed: ";t.message.includes("QUOTA_BYTES")||t.message.includes("quota")?n+="Storage quota exceeded. Please export your data and clear some collections or history to free up space.":t.message.includes("permission")?n+="Storage permission denied. Please check browser extension permissions.":n+=`Unable to ${e}. ${t.message||"Unknown storage error occurred."}`,v(n,`Operation: ${e}`)}function x(e,t){const n=document.createElement("div");n.className="key-value-row",t==="body"&&e.id==="formDataFieldsContainer"?n.innerHTML=`
            <input type="text" placeholder="Key" class="key-input">
            <div class="value-input-container">
                <select class="value-type-select">
                    <option value="text">Text</option>
                    <option value="file">File</option>
                </select>
                <input type="text" placeholder="Value" class="value-input">
                <input type="file" class="file-input" style="display: none;">
            </div>
            <input type="text" placeholder="Description" class="description-input">
            <button type="button" class="delete-btn">×</button>
        `:n.innerHTML=`
            <input type="text" placeholder="Key" class="key-input">
            <input type="text" placeholder="Value" class="value-input">
            <input type="text" placeholder="Description" class="description-input">
            <button type="button" class="delete-btn">×</button>
        `;const o=n.querySelector(".key-input"),r=n.querySelector(".value-input"),s=n.querySelector(".delete-btn"),a=n.querySelector(".value-type-select"),i=n.querySelector(".file-input");o.addEventListener("input",async()=>await re(t)),r.addEventListener("input",async()=>await re(t)),s.addEventListener("click",()=>{n.remove(),re(t)}),a&&i&&(a.addEventListener("change",()=>{a.value==="file"?(r.style.display="none",i.style.display="block",r.value=""):(r.style.display="block",i.style.display="none",i.value=""),re(t)}),i.addEventListener("change",()=>{re(t)})),e.appendChild(n)}function Q(e){const t=document.getElementById(e);if(!t)return{};const n=t.querySelectorAll(".key-value-row"),o={};return n.forEach(r=>{const s=r.querySelector(".key-input"),a=r.querySelector(".value-input"),i=s.value.trim(),l=a.value.trim();i&&(o[i]=l)}),o}async function Ge(e){const t=document.getElementById(e);if(!t)return[];const n=t.querySelectorAll(".key-value-row"),o=Array.from(n).map(async a=>{var m,p,f;const i=a.querySelector(".key-input"),l=a.querySelector(".value-type-select"),d=a.querySelector(".value-input"),u=a.querySelector(".file-input"),y=(m=i==null?void 0:i.value)==null?void 0:m.trim();if(!y)return null;if(console.log("Collecting field:",{key:y,valueTypeSelect:l==null?void 0:l.value,hasFile:!!((p=u==null?void 0:u.files)!=null&&p[0]),textValue:d==null?void 0:d.value}),l&&l.value==="file"){const h=(f=u==null?void 0:u.files)==null?void 0:f[0];if(h)try{const g=await $t(h);return console.log("Adding file field:",{key:y,filename:h.name,type:h.type,size:h.size,contentLength:g.length}),{key:y,type:"file",file:h,fileName:h.name,fileType:h.type,fileSize:h.size,fileContent:g}}catch(g){return console.error("Failed to convert file to base64:",g),xt(h.name,g),{key:y,type:"file",fileName:h.name+" (conversion failed)"}}else{const g=a.querySelector("span[data-file-info]");if(g){const b=JSON.parse(g.dataset.fileInfo||"{}");if(b.fileContent){const F=ae(b.fileContent,b.fileName,b.fileType);return console.log("Restored file from saved data:",b.fileName),{key:y,type:"file",file:F,fileName:b.fileName,fileType:b.fileType,fileSize:b.fileSize,fileContent:b.fileContent}}}return console.log("File field has no file selected:",y),{key:y,type:"file",fileName:"No file selected"}}}else{const h=(d==null?void 0:d.value)||"";return console.log("Adding text field:",{key:y,value:h}),{key:y,type:"text",value:h}}}),s=(await Promise.all(o)).filter(a=>a!==null);return console.log("collectFormDataWithFiles result:",s),s}function $t(e){return new Promise((t,n)=>{if(e.size>10485760){n(new Error(`File too large: ${J(e.size)}. Maximum size is ${J(10485760)}.`));return}["text/","application/json","application/xml","application/pdf","image/","video/","audio/","application/octet-stream"].some(i=>e.type.startsWith(i))||e.type===""||console.warn(`File type ${e.type} may not be supported, but proceeding anyway.`);const a=new FileReader;a.onload=()=>{try{const i=a.result;if(!i||typeof i!="string"){n(new Error("Failed to read file content"));return}const l=i.split(",")[1];if(!l){n(new Error("Invalid file format or empty file"));return}t(l)}catch(i){n(new Error(`Failed to process file "${e.name}": ${i.message}`))}},a.onerror=()=>{n(new Error(`Failed to read file "${e.name}". The file may be corrupted or in use by another application.`))},a.readAsDataURL(e)})}function ae(e,t,n){try{if(!e||typeof e!="string")throw new Error("Invalid Base64 data");const o=atob(e),r=new ArrayBuffer(o.length),s=new Uint8Array(r);for(let i=0;i<o.length;i++)s[i]=o.charCodeAt(i);const a=new Blob([r],{type:n});return new File([a],t,{type:n})}catch(o){throw console.error("Failed to restore file from Base64:",o),o.name==="InvalidCharacterError"?new Error(`Invalid Base64 data for file "${t}". The file data may be corrupted.`):new Error(`Failed to restore file "${t}": ${o.message}`)}}async function re(e){if(!c.currentRequest){console.warn("updateRequestData: state.currentRequest が未定義です");return}e==="param"?c.currentRequest.params=Q("paramsContainer"):e==="header"&&(c.currentRequest.headers=Q("headersContainer"))}function Co(){document.querySelectorAll('input[name="bodyType"]').forEach(e=>{e.addEventListener("change",async()=>{var o;const t=(o=document.querySelector('input[name="bodyType"]:checked'))==null?void 0:o.value;if(!t||!c.currentRequest)return;c.currentRequest.bodyType=t;const n=c.collections.find(r=>r.id===c.currentCollection);if(n&&c.currentRequest){const r=n.requests.find(s=>s.id===c.currentRequest.id);r&&(r.bodyType=t)}await P(),w(`Body Type を "${t}" に切り替えました`),V({target:{value:t}})})})}function ut(e){if(c.currentCollection){const t=c.collections.find(o=>o.id===c.currentCollection),n=t==null?void 0:t.requests.find(o=>o.id===e);if(n)return n.body}if(c.currentScenario){const t=c.scenarios.find(o=>o.id===c.currentScenario),n=t==null?void 0:t.requests.find(o=>o.id===e);if(n)return n.body}}function Rt(){Co(),xo()}function xo(){$o(),It()}function $o(){const e=document.getElementById("saveBtn");e&&e.addEventListener("click",t=>{t.preventDefault(),Xn()})}function It(){const e=document.getElementById("sendBtn");e&&e.addEventListener("click",async p=>{var R,U,we,te,T,ne,Se,Te,et,tt,nt;if(p.preventDefault(),!c.currentRequest)return;const f={...c.currentRequest},h=document.getElementById("methodSelect"),g=document.getElementById("nameInput"),b=document.getElementById("urlInput");f.method=(h==null?void 0:h.value)||f.method,f.name=((R=g==null?void 0:g.value)==null?void 0:R.trim())||f.name,f.url=((U=b==null?void 0:b.value)==null?void 0:U.trim())||f.url;const F=document.querySelectorAll("#headersContainer .key-value-row"),k={};F.forEach(B=>{var de,pe;const I=B,H=I.querySelector(".key-input"),Y=I.querySelector(".value-input"),ue=(de=H==null?void 0:H.value)==null?void 0:de.trim(),Ie=(pe=Y==null?void 0:Y.value)==null?void 0:pe.trim();ue&&(k[ue]=Ie||"")}),f.headers=k;const C=document.querySelectorAll("#paramsContainer .key-value-row"),q={};C.forEach(B=>{var de,pe;const I=B,H=I.querySelector(".key-input"),Y=I.querySelector(".value-input"),ue=(de=H==null?void 0:H.value)==null?void 0:de.trim(),Ie=(pe=Y==null?void 0:Y.value)==null?void 0:pe.trim();ue&&(q[ue]=Ie||"")}),f.params=q;const $=((we=document.querySelector('input[name="bodyType"]:checked'))==null?void 0:we.value)||"none";switch(f.bodyType=$,f.body=null,$){case"raw":{const B=(T=(te=document.getElementById("rawBody"))==null?void 0:te.value)==null?void 0:T.trim();f.body=B||f.body;break}case"json":{const B=(Se=(ne=document.getElementById("jsonBody"))==null?void 0:ne.value)==null?void 0:Se.trim();f.body=B||f.body;break}case"form-data":{const B=await Ge("formDataFieldsContainer");if(B.length>0)f.body=B;else if(Array.isArray((Te=c==null?void 0:c.currentRequest)==null?void 0:Te.body)){console.log("🔍 [utils.ts] No new form-data selected → using getPersistedBody");const I=ut(f.id);f.body=I??[]}break}case"urlencoded":{const B=Q("formDataFieldsContainer");Object.keys(B).length>0?f.body=B:typeof((et=c.currentRequest)==null?void 0:et.body)=="object"&&!Array.isArray(c.currentRequest.body)&&(f.body=c.currentRequest.body);break}case"binary":{const B=document.getElementById("binaryFileInput");let I=(tt=B==null?void 0:B.files)==null?void 0:tt[0];if(!I&&((nt=c.currentRequest)==null?void 0:nt.body)instanceof File&&(I=c.currentRequest.body),I)f.body=I,console.log("🔍 [utils.ts] Sending binary file:",{name:I.name,size:I.size});else{console.log("🔍 [utils.ts] No new binary selected → using getPersistedBody");const H=ut(f.id);f.body=H??null}break}}const L=document.getElementById("preRequestScript");L&&(f.preRequestScript=L.value),ft(f)});const t=document.getElementById("methodSelect");t&&t.addEventListener("change",p=>{const f=p.target;c.currentRequest&&(c.currentRequest.method=f.value)});const n=document.getElementById("urlInput");n&&n.addEventListener("input",p=>{const f=p.target;c.currentRequest&&(c.currentRequest.url=f.value)});const o=document.getElementById("importBtn");o&&o.addEventListener("click",()=>{fo()});const r=document.getElementById("exportBtn");r&&r.addEventListener("click",()=>{qo()});const s=document.getElementById("createCollectionBtn");s&&s.addEventListener("click",async()=>{kt()});const a=document.getElementById("createScenarioFromSidebarBtn");a&&a.addEventListener("click",async()=>{const{createNewScenario:p}=await ie(async()=>{const{createNewScenario:f}=await Promise.resolve().then(()=>Zn);return{createNewScenario:f}},void 0);p()});const i=document.getElementById("historySearch");i&&i.addEventListener("input",()=>{Cn()});const l=document.getElementById("clearHistoryBtn");l&&l.addEventListener("click",async()=>{Bn()});const d=document.getElementById("startInterceptorBtn");d&&d.addEventListener("click",async()=>{co()});const u=document.getElementById("stopInterceptorBtn");u&&u.addEventListener("click",async()=>{lo()}),document.querySelectorAll('input[name="bodyType"]').forEach(p=>{p.addEventListener("change",f=>{V(f)})});const y=document.getElementById("rawBody");y&&y.addEventListener("input",p=>{const f=p.target;c.currentRequest&&(c.currentRequest.body=f.value)});const m=document.getElementById("binaryFileInput");m&&m.addEventListener("change",p=>{var b;const h=(b=p.target.files)==null?void 0:b[0],g=document.getElementById("binaryFileInfo");h&&g?(g.innerHTML=`
                    <div class="selected-binary-file">
                        <span class="file-name">Selected: ${h.name}</span>
                        <span class="file-size">(${J(h.size)})</span>
                        <span class="file-type">${h.type||"Unknown type"}</span>
                    </div>
                `,console.log("🔍 [utils.ts] Binary file selected:",{name:h.name,size:h.size,type:h.type})):g&&(g.innerHTML="")})}function Dt(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.tab;t&&ve(t)})}),document.querySelectorAll(".sub-tab-btn").forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.subtab;t&&Lt(t)})}),document.querySelectorAll(".response-tab-btn").forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.restab;t&&_t(t)})}),document.querySelectorAll(".format-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".format-btn").forEach(n=>n.classList.remove("active")),this.classList.add("active");const t=this.dataset.format;t&&window.lastResponse&&Je(window.lastResponse,t)})})}function ve(e){console.log(e),document.querySelectorAll(".tab-btn").forEach(o=>o.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(o=>o.classList.remove("active"));const t=document.querySelector(`.tab-btn[data-tab="${e}"]`),n=document.getElementById(`${e}-tab`);t&&t.classList.add("active"),n&&n.classList.add("active")}function Lt(e){document.querySelectorAll(".sub-tab-btn").forEach(o=>o.classList.remove("active")),document.querySelectorAll(".sub-tab-content").forEach(o=>o.classList.remove("active"));const t=document.querySelector(`[data-subtab="${e}"]`),n=document.getElementById(`${e}-subtab`);t&&t.classList.add("active"),n&&n.classList.add("active"),setTimeout(()=>{if(e==="pre-request"){const o=document.getElementById("preRequestScript");o&&X(o)}else if(e==="tests"){const o=document.getElementById("testScript");o&&X(o)}},10)}function _t(e){document.querySelectorAll(".response-tab-btn").forEach(o=>o.classList.remove("active")),document.querySelectorAll(".response-tab-content").forEach(o=>o.classList.remove("active"));const t=document.querySelector(`[data-restab="${e}"]`),n=document.getElementById(`response-${e}`);t&&t.classList.add("active"),n&&n.classList.add("active")}function $e(e){const t=document.getElementById("authDetails");if(t){switch(t.innerHTML="",e){case"basic":t.innerHTML=`
                <div class="auth-field">
                    <label>Username</label>
                    <input type="text" id="authUsername" placeholder="Enter username">
                </div>
                <div class="auth-field">
                    <label>Password</label>
                    <input type="password" id="authPassword" placeholder="Enter password">
                </div>
            `;break;case"bearer":t.innerHTML=`
                <div class="auth-field">
                    <label>Token</label>
                    <input type="text" id="authToken" placeholder="Enter bearer token">
                </div>
            `;break;case"apikey":t.innerHTML=`
                <div class="auth-field">
                    <label>Key</label>
                    <input type="text" id="authKey" placeholder="Enter API key name">
                </div>
                <div class="auth-field">
                    <label>Value</label>
                    <input type="text" id="authValue" placeholder="Enter API key value">
                </div>
                <div class="auth-field">
                    <label>Add to</label>
                    <select id="authAddTo">
                        <option value="header">Header</option>
                        <option value="query">Query Params</option>
                    </select>
                </div>
            `;break;case"oauth2":t.innerHTML=`
                <div class="auth-field">
                    <label>Access Token</label>
                    <input type="text" id="authAccessToken" placeholder="Enter access token">
                </div>
                <div class="auth-field">
                    <label>Token Type</label>
                    <select id="authTokenType">
                        <option value="Bearer">Bearer</option>
                        <option value="MAC">MAC</option>
                    </select>
                </div>
                <button class="btn btn-sm" onclick="getOAuth2Token()">Get New Access Token</button>
            `;break}t.querySelectorAll("input, select").forEach(n=>{n.addEventListener("input",ge),n.addEventListener("change",ge)})}}function ge(){var t;if(!c.currentRequest){console.error("updateAuthData: state.currentRequest が undefined です");return}const e=((t=c.currentRequest.auth)==null?void 0:t.type)||"none";switch(c.currentRequest.auth={type:e},e){case"basic":const n=document.getElementById("authUsername"),o=document.getElementById("authPassword");c.currentRequest.auth.username=(n==null?void 0:n.value)||"",c.currentRequest.auth.password=(o==null?void 0:o.value)||"";break;case"bearer":const r=document.getElementById("authToken");c.currentRequest.auth.token=(r==null?void 0:r.value)||"";break;case"apikey":const s=document.getElementById("authKey"),a=document.getElementById("authValue"),i=document.getElementById("authAddTo");c.currentRequest.auth.key=(s==null?void 0:s.value)||"",c.currentRequest.auth.value=(a==null?void 0:a.value)||"",c.currentRequest.auth.addTo=(i==null?void 0:i.value)||"header";break;case"oauth2":const l=document.getElementById("authAccessToken"),d=document.getElementById("authTokenType");c.currentRequest.auth.accessToken=(l==null?void 0:l.value)||"",c.currentRequest.auth.tokenType=(d==null?void 0:d.value)||"Bearer";break}}function Ne(e){const t=document.getElementById("sendBtn");t&&(e?(t.disabled=!0,t.textContent="Sending..."):(t.disabled=!1,t.textContent="Send"))}function V(e){const t=e.target.value,n=document.getElementById("rawBody"),o=document.getElementById("jsonEditor"),r=document.getElementById("formDataContainer"),s=document.getElementById("binaryContainer");if(!(!n||!o||!r||!s))switch(n.style.display="none",o.style.display="none",r.style.display="none",s.style.display="none",t){case"raw":n.style.display="block";break;case"json":o.style.display="block";break;case"form-data":case"urlencoded":r.style.display="block";const a=document.getElementById("formDataFieldsContainer");a&&!a.children.length&&x(a,"body");break;case"binary":s.style.display="block";break}}async function Ot(e){return await Ge(e)}async function Pt(e){var o;const t=document.getElementById(e),n=(o=t==null?void 0:t.files)==null?void 0:o[0];if(!n)return null;try{const r=await $t(n);return JSON.stringify({type:"binaryFile",fileName:n.name,fileType:n.type,fileSize:n.size,base64Data:r})}catch(r){return v(`Failed to serialize binary file "${n.name}": ${r.message}`),null}}function X(e){e.style.height="auto",e.style.height=e.scrollHeight+100+"px"}const At=Object.freeze(Object.defineProperty({__proto__:null,addKeyValueRow:x,autoResizeTextarea:X,base64ToFile:ae,collectFormDataWithFiles:Ge,collectKeyValues:Q,escapeHtml:_,formatBytes:J,handleBodyTypeChange:V,renderAuthDetails:$e,serializeBinaryFile:Pt,serializeFormDataWithFiles:Ot,setupEventListeners:Rt,setupSendButton:It,setupTabSwitching:Dt,showError:v,showFileError:xt,showLoading:Ne,showNetworkError:Ct,showNotification:Ke,showStorageError:Bo,showSuccess:w,showVariableError:Be,switchMainTab:ve,switchResponseTab:_t,switchSubTab:Lt,updateAuthData:ge,updateRequestData:re},Symbol.toStringTag,{value:"Module"}));function Ro(){const e=document.getElementById("newEnvironmentBtn"),t=document.getElementById("editEnvironmentBtn"),n=document.getElementById("environmentSelect"),o=document.getElementById("addGlobalVarBtn"),r=document.getElementById("addEnvVarBtn"),s=document.getElementById("addCollectionVarBtn"),a=document.getElementById("collectionVarSelect");e==null||e.addEventListener("click",Do),t==null||t.addEventListener("click",Lo),n==null||n.addEventListener("change",Nt),o==null||o.addEventListener("click",()=>Le("global")),r==null||r.addEventListener("click",()=>Le("environment")),s==null||s.addEventListener("click",()=>Le("collection")),a==null||a.addEventListener("change",async()=>{const i=a.value;c.selectedCollectionForVars=i,console.log("Collection changed to:",i),console.log("Collection variables data:",c.variables.collection),console.log("Selected collection variables:",c.variables.collection[i]),N("collection")})}async function Io(){var e;try{{const n=(await chrome.storage.local.get(["variables"])).variables||{};!n.global||Object.keys(n.global).length===0?(c.variables.global={...ot},c.variables.collection=n.collection||{},await chrome.storage.local.set({variables:{global:c.variables.global,collection:c.variables.collection}})):(c.variables.global={...ot,...n.global},c.variables.collection=n.collection||{},await chrome.storage.local.set({variables:{global:c.variables.global,collection:c.variables.collection}}))}{const n=(await chrome.storage.local.get(["environments"])).environments||[];if(n.length===0){c.environments=[...rt];for(const o of rt){const r=Vt[o.id]||{};c.variables.environment={...r},await chrome.storage.local.set({[`env_${o.id}`]:c.variables.environment})}await chrome.storage.local.set({environments:c.environments})}else if(c.environments.splice(0,c.environments.length,...n),c.currentEnvironment){const o=await chrome.storage.local.get([`env_${c.currentEnvironment}`]);c.variables.environment=o[`env_${c.currentEnvironment}`]||{}}else c.variables.environment={}}{const n=((e=(await chrome.storage.local.get(["variables"])).variables)==null?void 0:e.collection)||{};!n||Object.keys(n).length===0?(c.variables.collection={...zt},await chrome.storage.local.set({variables:{global:c.variables.global,collection:c.variables.collection}})):c.variables.collection=n}Ee(),Ro(),z(),Xe(),console.log("Variables management initialized")}catch(t){console.error("Error initializing variables management:",t)}}function Ee(){const e=document.getElementById("environmentSelect");if(!e)return;e.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="No Environment",e.appendChild(t),c.environments.forEach(n=>{const o=document.createElement("option");o.value=n.id,o.textContent=n.name,n.id===c.currentEnvironment&&(o.selected=!0),e.appendChild(o)})}async function Do(){const e=prompt("Enter environment name:");if(!e)return;const t={id:`env_${Date.now()}_${Math.random().toString(36).substring(2)}`,name:e,variables:{},created:new Date().toISOString()};c.environments.push(t),await Re(),await chrome.storage.local.set({[`env_${t.id}`]:{}}),Ee();const n=document.getElementById("environmentSelect");n&&(n.value=t.id),await Nt(),w("Environment created: "+e)}async function Lo(){if(!c.currentEnvironment){v("No environment selected");return}const e=c.environments.find(n=>n.id===c.currentEnvironment);if(!e)return;const t=prompt("Edit environment name:",e.name);!t||t===e.name||(e.name=t,await Re(),Ee(),w("Environment renamed to: "+t))}async function Nt(){var o;const e=document.getElementById("environmentSelect");if(!e)return;const t=e.value;if(c.currentEnvironment&&await Qe(c.currentEnvironment),c.currentEnvironment=t,await Ao(),t){const r=await chrome.storage.local.get([`env_${t}`]);c.variables.environment=r[`env_${t}`]||{}}else c.variables.environment={};const n=t?(o=c.environments.find(r=>r.id===t))==null?void 0:o.name:"No Environment";w("Switched to: "+n),N("environment")}function z(){const e=document.getElementById("collectionVarSelect");if(!e)return;e.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="Select Collection",e.appendChild(t),c.collections.forEach(n=>{const o=document.createElement("option");o.value=n.id,o.textContent=n.name,n.id===c.currentCollection&&(o.selected=!0),e.appendChild(o)})}function Xe(){N("global"),N("environment"),N("collection")}function N(e){let t,n;if(e==="global")t=document.getElementById("globalVariablesContainer"),n=c.variables.global;else if(e==="environment"){if(t=document.getElementById("envVariablesContainer"),!c.currentEnvironment){t&&(t.innerHTML='<p class="empty-message">Select an environment to manage variables</p>'),console.log("renderVariables is return currentEnvironment");return}n=c.variables.environment}else if(e==="collection"){t=document.getElementById("collectionVariablesContainer");const s=c.selectedCollectionForVars;if(!s){t&&(t.innerHTML='<p class="empty-message">Select a collection to manage variables</p>'),console.log("renderVariables is return selectedCollectionForVars");return}n=c.variables.collection[s]||{},console.log(`renderVariables collection: selectedCollectionId=${s}, data=`,n)}else{console.log("renderVariables is return");return}if(!t)return;t.innerHTML="";const o=document.createElement("div");o.className="variable-header-row",o.innerHTML=`
      <span>Variable</span>
      <span>Value</span>
      <span>Description</span>
      <span></span>
    `,t.appendChild(o);const r=Object.entries(n||{});if(r.length===0){const s=document.createElement("div");s.className="empty-variables",s.innerHTML='<p>No variables defined. Click "Add" to create one.</p>',t.appendChild(s)}else r.forEach(([s,a])=>{const{value:i,description:l}=a,d=jt(e,s,i,l);t.appendChild(d)})}function jt(e,t="",n="",o=""){const r=document.createElement("div");r.className="variable-row",r.dataset.originalKey=t,r.innerHTML=`
        <input type="text" class="var-key" placeholder="Variable name" value="${_(t)}">
        <input type="text" class="var-value" placeholder="Value" value="${_(n)}">
        <input type="text" class="var-description" placeholder="Description" value="${_(o)}">
        <button class="delete-btn">×</button>
    `;const s=r.querySelector(".var-key"),a=r.querySelector(".var-value"),i=r.querySelector(".var-description"),l=r.querySelector(".delete-btn"),d=async()=>{const m=s.value.trim(),p=a.value,f=i.value,h=r.dataset.originalKey||"";if(!m){h&&await De(e,h);return}if(m!==h&&_o(e,m)){v(`Variable "${m}" already exists in this scope`),s.value=h;return}h&&h!==m&&await De(e,h),await Oo(e,m,p,f),r.dataset.originalKey=m,console.log(`Variable "${m}" saved successfully`)};let u=null;const y=()=>{u&&clearTimeout(u),u=setTimeout(d,500)};return s.addEventListener("blur",d),a.addEventListener("blur",d),i.addEventListener("blur",d),s.addEventListener("input",y),a.addEventListener("input",y),i.addEventListener("input",y),l.addEventListener("click",async()=>{const m=r.dataset.originalKey||s.value.trim();m?confirm(`Delete variable "${m}"?`)&&(await De(e,m),r.remove(),w(`Variable "${m}" deleted`)):r.remove()}),r}function _o(e,t){switch(e){case"global":return t in c.variables.global;case"environment":return t in c.variables.environment;case"collection":const n=c.selectedCollectionForVars;return n&&c.variables.collection[n]&&t in c.variables.collection[n]}return!1}async function Oo(e,t,n,o){const r={value:n,description:o};switch(e){case"global":c.variables.global[t]=r,await Z();break;case"environment":if(!c.currentEnvironment){console.error("No environment selected for saving variable");return}c.variables.environment[t]=r,console.log("Saving environment variable:",t,r,"to environment:",c.currentEnvironment),console.log("Current environment variables:",c.variables.environment),await Qe(c.currentEnvironment);break;case"collection":const s=c.selectedCollectionForVars;if(!s){console.error("No collection selected for saving variable");return}c.variables.collection[s]||(c.variables.collection[s]={}),c.variables.collection[s][t]=r,console.log("Saving collection variable:",t,r,"to collection:",s),console.log("Collection variables after save:",c.variables.collection[s]),console.log("All collection variables:",c.variables.collection),await Z();break}console.log(`Variable saved: ${e}.${t} = ${n}`)}async function De(e,t){switch(e){case"global":delete c.variables.global[t],await Z(),N("global");break;case"environment":if(!c.currentEnvironment)return;delete c.variables.environment[t],await Qe(c.currentEnvironment),N("environment");break;case"collection":const n=c.selectedCollectionForVars;if(!n)return;delete c.variables.collection[n][t],await Z(),N("collection");break}}function Le(e){if(e==="environment"&&!c.currentEnvironment){v("Please select an environment first");return}if(e==="collection"&&!c.selectedCollectionForVars){v("Please select a collection first");return}let t;switch(e){case"global":t=document.getElementById("globalVariablesContainer");break;case"environment":t=document.getElementById("envVariablesContainer");break;case"collection":t=document.getElementById("collectionVariablesContainer");break;default:return}if(!t)return;const n=t.querySelector(".empty-variables");n&&n.remove();const o=jt(e);t.appendChild(o);const r=o.querySelector(".var-key");r==null||r.focus()}function Po(e){if(e.length<4)throw new Error(`変数参照構文が不正です: ${JSON.stringify(e)}`);const t=e[0]==="scenarios",n=e[1],o=e[2],r=e[3],s=e.slice(4);let a;if(t){const d=c.scenarios.find(u=>u.name===n);if(!d)throw new Error(`シナリオ「${n}」が見つかりません`);if(a=d.requests.find(u=>u.name===o),!a)throw new Error(`シナリオ「${n}」内にリクエスト「${o}」が見つかりません`)}else{const d=c.collections.find(u=>u.name===n);if(!d)throw new Error(`コレクション「${n}」が見つかりません`);if(a=d.requests.find(u=>u.name===o),!a)throw new Error(`コレクション「${n}」内にリクエスト「${o}」が見つかりません`)}const i=r==="response"?a.lastResponseExecution:a.lastRequestExecution;if(!i)throw new Error(`${r} の実行結果が存在しません`);let l=i;for(let d=0;d<s.length;d++){const u=s[d];if(typeof u=="object"&&"jsonPath"in u){const m=u.jsonPath,p=typeof l=="string"?JSON.parse(l):l,f=S({path:m,json:p});if(!Array.isArray(f)||f.length===0)throw new Error(`JSONPath "${m}" に一致する値がありません`);return f[0]}if(u==="headers"){const m=s[++d],p=Object.entries(l.headers||{}).find(([f])=>f.toLowerCase()===m.toLowerCase());if(!p)throw new Error(`ヘッダー "${m}" が見つかりません`);return p[1]}if(u==="body"){l=l.body;continue}const y=u;if(l!=null&&typeof l=="object"&&y in l)l=l[y];else throw new Error(`プロパティ "${y}" が見つかりません`)}return l}function K(e){var n,o;if(console.log("🔍 [getVariable] START - varName:",e),e.startsWith("${")&&e.endsWith("}")){const r=e.slice(2,-1),s=[],a=/\.?"([^"]+)"|\.jsonPath\("([^"]+)"\)/g;let i,l=0;for(;(i=a.exec(r))!==null;){if(i.index!==l)throw new Error(`変数参照構文が不正です: ${r.slice(l,i.index)}`);l=a.lastIndex,i[1]!==void 0?s.push(i[1]):s.push({jsonPath:i[2]})}if(l<r.length)throw new Error(`変数参照構文が不正です: ${r.slice(l)}`);return console.log("🔍 [getVariable] Parsed parts:",s),Po(s)}if(e.startsWith("{{")&&e.endsWith("}}")){const r=e.slice(2,-2).trim();return c.variables.environment[r]?c.variables.environment[r].value:c.variables.global[r]?c.variables.global[r].value:c.currentCollection&&((n=c.variables.collection[c.currentCollection])!=null&&n[r])?c.variables.collection[c.currentCollection][r].value:void 0}const t=e.trim();if(c.variables.environment[t])return c.variables.environment[t].value;if(c.variables.global[t])return c.variables.global[t].value;if(c.currentCollection&&((o=c.variables.collection[c.currentCollection])!=null&&o[t]))return c.variables.collection[c.currentCollection][t].value;console.log("🔍 [getVariable] Variable not found:",e)}function j(e){if(typeof e!="string")return e;let t=e,n=0;for(;n<t.length;){const o=t.indexOf("${",n);if(o===-1)break;let r=0,s=o+2,a=!1,i=!1;for(;s<t.length;){const l=t[s];if(i){i=!1,s++;continue}if(l==="\\"){i=!0,s++;continue}if(l==='"'&&!i)a=!a;else if(!a){if(l==="{")r++;else if(l==="}")if(r===0){const d=t.substring(o,s+1);try{const u=K(d);u!==void 0?(t=t.substring(0,o)+u+t.substring(s+1),n=o+String(u).length):n=s+1}catch(u){console.warn("Variable replacement failed for:",d,u),(u.message.includes("見つかりません")||u.message.includes("not found"))&&Be(d,u),n=s+1}break}else r--}s++}s>=t.length&&(n=o+2)}return t=t.replace(/\{\{([^}]+)\}\}/g,(o,r)=>{const s=r.trim(),a=K(s);return a!==void 0?a:o}),t=t.replace(/\{([^}]+)\}/g,(o,r)=>{const s=r.trim(),a=K(s);return a!==void 0?a:o}),t}function me(e){if(typeof e=="string")return j(e);if(Array.isArray(e))return e.map(me);if(e&&typeof e=="object"){const t={};for(const[n,o]of Object.entries(e)){const r=j(n);t[r]=me(o)}return t}return e}async function be(e,t,n){const o={value:n,description:""};switch(e){case"global":c.variables.global[t]=o,await chrome.storage.local.set({variables:{global:c.variables.global,collection:c.variables.collection}});break;case"environment":c.currentEnvironment&&(c.variables.environment[t]=o,await chrome.storage.local.set({[`env_${c.currentEnvironment}`]:c.variables.environment}));break}}const c={currentRequest:{id:"",name:"",method:"GET",url:"",headers:{},params:{},body:null,auth:{type:"none"},folder:"",description:"",bodyType:"none",preRequestScript:""},collections:[],history:[],variables:{global:{},environment:{},collection:{}},environments:[],currentEnvironment:null,currentCollection:null,scenarios:[],currentScenario:null,sidebarState:{expandedCollections:new Set,expandedScenarios:new Set}},Ye=c;Ye.testScripts=[];Ye.settings={};Ye.isInterceptorActive=!1;async function P(){try{await chrome.storage.local.set({collections:c.collections});const e=await chrome.storage.local.get(["collections"]);c.collections.splice(0,c.collections.length,...e.collections),z()}catch(e){console.error("Failed to save collections to storage:",e);const{showStorageError:t}=await ie(async()=>{const{showStorageError:n}=await Promise.resolve().then(()=>At);return{showStorageError:n}},void 0);throw t("save collections",e),e}}async function Mt(){try{await chrome.storage.local.set({history:c.history})}catch(e){console.error("Failed to save history to storage:",e);const{showStorageError:t}=await ie(async()=>{const{showStorageError:n}=await Promise.resolve().then(()=>At);return{showStorageError:n}},void 0);throw t("save history",e),e}}async function Z(){await chrome.storage.local.set({variables:{global:c.variables.global,collection:c.variables.collection,environment:c.variables.environment}})}async function Re(){await chrome.storage.local.set({environments:c.environments})}async function Ao(){await chrome.storage.local.set({currentEnvironment:c.currentEnvironment})}async function Qe(e){await chrome.storage.local.set({[`env_${e}`]:c.variables.environment})}async function Ze(){await chrome.storage.local.set({currentCollection:c.currentCollection})}async function A(){await chrome.storage.local.set({scenarios:c.scenarios}),ee()}async function Ce(){await chrome.storage.local.set({currentScenario:c.currentScenario})}async function xe(){try{if(c.sidebarState){const e={expandedCollections:Array.from(c.sidebarState.expandedCollections),expandedScenarios:Array.from(c.sidebarState.expandedScenarios)};await chrome.storage.local.set({sidebarState:e})}}catch(e){console.error("Error saving sidebar state:",e)}}const _e={openDevTools:!0,requestTimeout:3e4,followRedirects:!0,validateSSL:!0,maxHistoryItems:100};class se{constructor(){this.settings={..._e},this.loadSettings()}static getInstance(){return se.instance||(se.instance=new se),se.instance}async loadSettings(){try{const t=await chrome.storage.sync.get("settings");t.settings&&(this.settings={..._e,...t.settings})}catch(t){console.error("設定の読み込みに失敗しました:",t)}}async saveSettings(t){try{this.settings={...this.settings,...t},await chrome.storage.sync.set({settings:this.settings})}catch(n){console.error("設定の保存に失敗しました:",n)}}getSettings(){return{...this.settings}}async resetSettings(){try{this.settings={..._e},await chrome.storage.sync.set({settings:this.settings})}catch(t){console.error("設定のリセットに失敗しました:",t)}}}function Ht(){const e=se.getInstance(),t=e.getSettings(),n=document.getElementById("openDevTools"),o=document.getElementById("requestTimeout"),r=document.getElementById("followRedirects"),s=document.getElementById("validateSSL"),a=document.getElementById("maxHistoryItems");n&&(n.checked=t.openDevTools),o&&(o.value=t.requestTimeout.toString()),r&&(r.checked=t.followRedirects),s&&(s.checked=t.validateSSL),a&&(a.value=t.maxHistoryItems.toString());const i=document.getElementById("saveSettings");i&&i.addEventListener("click",async()=>{const d={openDevTools:(n==null?void 0:n.checked)??!0,requestTimeout:parseInt((o==null?void 0:o.value)??"30000"),followRedirects:(r==null?void 0:r.checked)??!0,validateSSL:(s==null?void 0:s.checked)??!0,maxHistoryItems:parseInt((a==null?void 0:a.value)??"100")};await e.saveSettings(d),je()});const l=document.getElementById("resetSettings");l&&l.addEventListener("click",async()=>{await e.resetSettings(),Ht()})}function No(){const e=document.getElementById("settingsModal");e&&e.classList.add("active")}function je(){const e=document.getElementById("settingsModal");e&&e.classList.remove("active")}function jo(){var n;const e=document.getElementById("settingsBtn"),t=document.querySelector("#settingsModal .close-btn");e==null||e.addEventListener("click",No),t==null||t.addEventListener("click",je),(n=document.getElementById("settingsModal"))==null||n.addEventListener("click",o=>{o.target===o.currentTarget&&je()})}function Mo(){const e=document.getElementById("authType");e==null||e.addEventListener("change",function(){const t=this.value;c.currentRequest&&(c.currentRequest.auth.type=t,$e(t))})}function Ho(){const e=document.getElementById("importExportModal");if(!e)return;e.querySelectorAll(".modal-close").forEach(s=>{s.addEventListener("click",function(){e.classList.remove("active")})}),e.addEventListener("click",function(s){s.target===e&&e.classList.remove("active")});const n=document.getElementById("importFile"),o=document.getElementById("fileDropZone");n&&n.addEventListener("change",lt),o&&(o.addEventListener("click",function(){n==null||n.click()}),o.addEventListener("dragover",function(s){s.preventDefault(),this.classList.add("dragover")}),o.addEventListener("dragleave",function(){this.classList.remove("dragover")}),o.addEventListener("drop",function(s){var i;s.preventDefault(),this.classList.remove("dragover");const a=(i=s.dataTransfer)==null?void 0:i.files;a&&a.length>0&&lt({target:{files:a}})}));const r=document.getElementById("importSubmitBtn");r==null||r.addEventListener("click",ho)}function Vo(){Jo(),zo(),Uo()}function Jo(){const e=document.getElementById("paramsContainer");e&&e.children.length===0&&x(e,"param")}function zo(){const e=document.getElementById("headersContainer");e&&e.children.length===0&&x(e,"header")}function Uo(){const e=document.querySelector(".add-param");e==null||e.addEventListener("click",function(){const o=document.getElementById("paramsContainer");o&&x(o,"param")});const t=document.querySelector(".add-header");t==null||t.addEventListener("click",function(){const o=document.getElementById("headersContainer");o&&x(o,"header")});const n=document.querySelector(".add-form-data");n==null||n.addEventListener("click",function(){const o=document.getElementById("formDataFieldsContainer");o&&x(o,"body")})}function Wo(){try{const e=document.createElement("div");e.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 13px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease-out;
        `,e.innerHTML=`
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 16px;">🛠️</span>
                <span>Press F12 for better debugging experience</span>
            </div>
        `,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="1",e.style.transform="translateX(0)"},100),setTimeout(()=>{e.style.opacity="0",e.style.transform="translateX(100%)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},4e3),console.log("Developer tools guidance shown")}catch(e){console.warn("Failed to show developer tools guidance:",e)}}function Ko(){const e=document.getElementById("preRequestScript");e&&(X(e),e.addEventListener("input",()=>X(e)))}function Go(){const e=document.getElementById("testScript");e&&(X(e),e.addEventListener("input",()=>X(e)))}async function Xo(){try{Rt(),Dt(),Ho(),Ko(),Go(),chrome.runtime.onMessage.addListener(n=>{if(n.action==="openDevTools"){const o=document.querySelector('[data-tab="interceptor"]');o&&o.click()}else n.action==="openDevToolsF12"&&Wo()}),await wt(),await ht();const e=document.getElementById("newScenarioBtn");e==null||e.addEventListener("click",()=>{bt()});const t=document.getElementById("runScenarioBtn");t==null||t.addEventListener("click",()=>{Et()}),await Io(),Ve(),Vo(),Mo(),mo(),console.log("API Tester initialized successfully")}catch(e){console.error("Initialization error:",e),v("Failed to initialize: "+e.message)}}document.addEventListener("DOMContentLoaded",async()=>{await Xo();try{Ht(),jo()}catch(e){console.error("設定の初期化に失敗しました:",e)}});
