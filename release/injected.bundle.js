(function(){if(window.apiTesterInjected)return;window.apiTesterInjected=!0,console.log("API Tester injected script loaded");let c={interceptFetch:!0,interceptXHR:!0,logRequests:!1,autoCapture:!1},p=0;const l=new Map,h=window.fetch,I=XMLHttpRequest.prototype.open,R=XMLHttpRequest.prototype.send,f=window.WebSocket;function i(e,t){window.postMessage({type:e,payload:t,source:"api-tester-injected"},"*")}window.addEventListener("message",function(e){e.data.type==="API_TESTER_CONFIG"&&(c={...c,...e.data.payload},console.log("API Tester: Configuration updated",c))});function _(){window.fetch=function(...e){const t=++p,n=performance.now(),o=y(e,t,n);return l.set(t,o),i("API_TESTER_REQUEST",o),c.logRequests&&(console.group(`🚀 API Request #${t}`),console.log("URL:",o.url),console.log("Method:",o.method),console.log("Headers:",o.headers),console.log("Body:",o.body)),h.apply(this,e).then(a=>{const s=performance.now(),u=O(a,t,s-n);return i("API_TESTER_RESPONSE",u),c.logRequests&&(console.log("✅ Response received"),console.log("Status:",a.status,a.statusText),console.log("Headers:",u.headers),console.log("Duration:",u.duration+"ms"),console.groupEnd()),l.delete(t),a}).catch(a=>{const s=performance.now(),u={requestId:t,error:a.message,duration:s-n,status:0};throw i("API_TESTER_RESPONSE",u),c.logRequests&&(console.error("❌ Request failed:",a),console.log("Duration:",u.duration+"ms"),console.groupEnd()),l.delete(t),a})}}function w(){XMLHttpRequest.prototype.open=function(e,t,n=!0,o,r){const a=++p,s=performance.now();this._apiTesterInfo={requestId:a,method:e.toUpperCase(),url:g(t),startTime:s,headers:{},body:null};const u=this.setRequestHeader;return this.setRequestHeader=function(d,S){return this._apiTesterInfo&&(this._apiTesterInfo.headers[d]=S),u.call(this,d,S)},I.call(this,e,t,n,o,r)},XMLHttpRequest.prototype.send=function(e){if(this._apiTesterInfo){this._apiTesterInfo.body=e,l.set(this._apiTesterInfo.requestId,this._apiTesterInfo),i("API_TESTER_REQUEST",{requestId:this._apiTesterInfo.requestId,url:this._apiTesterInfo.url,method:this._apiTesterInfo.method,headers:this._apiTesterInfo.headers,body:this._apiTesterInfo.body,initiator:"XMLHttpRequest"}),c.logRequests&&(console.group(`🚀 XHR Request #${this._apiTesterInfo.requestId}`),console.log("URL:",this._apiTesterInfo.url),console.log("Method:",this._apiTesterInfo.method),console.log("Headers:",this._apiTesterInfo.headers),console.log("Body:",this._apiTesterInfo.body));const t=this;this.addEventListener("loadend",function(){if(!t._apiTesterInfo)return;const o=performance.now()-t._apiTesterInfo.startTime,r={requestId:t._apiTesterInfo.requestId,status:t.status,statusText:t.statusText,headers:q(t.getAllResponseHeaders()),duration:o};i("API_TESTER_RESPONSE",r),l.delete(t._apiTesterInfo.requestId)}),this.addEventListener("error",function(){if(!t._apiTesterInfo)return;const o=performance.now()-t._apiTesterInfo.startTime,r={requestId:t._apiTesterInfo.requestId,error:"Network error",duration:o,status:0};i("API_TESTER_RESPONSE",r),l.delete(t._apiTesterInfo.requestId)})}return R.call(this,e)}}function P(){window.WebSocket=new Proxy(f,{construct(e,t){const n=++p,o=performance.now(),r=new e(...t);i("API_TESTER_REQUEST",{requestId:n,url:t[0],method:"WEBSOCKET",headers:{},body:null,initiator:"WebSocket",protocols:t[1]}),c.logRequests&&(console.group(`🔌 WebSocket Connection #${n}`),console.log("URL:",t[0]),console.log("Protocols:",t[1]));const a=r.send;return r.send=function(s){return c.logRequests&&console.log("📤 WebSocket Send:",s),i("API_TESTER_WEBSOCKET_SEND",{requestId:n,data:s,timestamp:Date.now()}),a.call(this,s)},r.addEventListener("open",function(){const s=performance.now()-o;i("API_TESTER_RESPONSE",{requestId:n,status:101,statusText:"Switching Protocols",headers:{},body:"WebSocket connection established",duration:s}),c.logRequests&&(console.log("✅ WebSocket Connected"),console.log("Duration:",s+"ms"))}),r.addEventListener("message",function(s){c.logRequests&&console.log("📥 WebSocket Message:",s.data),i("API_TESTER_WEBSOCKET_MESSAGE",{requestId:n,data:s.data,timestamp:Date.now()})}),r.addEventListener("close",function(s){c.logRequests&&(console.log("🔌 WebSocket Closed:",s.code,s.reason),console.groupEnd()),i("API_TESTER_WEBSOCKET_CLOSE",{requestId:n,code:s.code,reason:s.reason,timestamp:Date.now()})}),r.addEventListener("error",function(s){c.logRequests&&(console.error("❌ WebSocket Error:",s),console.groupEnd()),i("API_TESTER_WEBSOCKET_ERROR",{requestId:n,error:"WebSocket error",timestamp:Date.now()})}),r}}),Object.setPrototypeOf(window.WebSocket,f),window.WebSocket.prototype=f.prototype,Object.defineProperty(window.WebSocket,"CONNECTING",{value:f.CONNECTING}),Object.defineProperty(window.WebSocket,"OPEN",{value:f.OPEN}),Object.defineProperty(window.WebSocket,"CLOSING",{value:f.CLOSING}),Object.defineProperty(window.WebSocket,"CLOSED",{value:f.CLOSED})}function y(e,t,n){const[o,r={}]=e;let a,s,u,d;return typeof o=="string"?a=o:o instanceof Request?(a=o.url,s=o.method,u=E(o.headers)):o instanceof URL?a=o.href:typeof o=="string"?a=o:a=String(o),s=s||r.method||"GET",u=u||E(r.headers)||{},d=d||r.body||null,{requestId:t,url:g(a),method:s.toUpperCase(),headers:u,body:C(d),initiator:"fetch",startTime:n}}function O(e,t,n){return{requestId:t,status:e.status,statusText:e.statusText,headers:E(e.headers),duration:n,size:null,redirected:e.redirected,url:e.url,type:e.type}}function E(e){if(!e)return{};const t={};if(e instanceof Headers)for(const[n,o]of e.entries())t[n]=o;else typeof e=="object"&&Object.assign(t,e);return t}function q(e){const t={};return e&&e.trim().split(`\r
`).forEach(n=>{const o=n.split(": ");o.length===2&&(t[o[0]]=o[1])}),t}function g(e){return e instanceof URL&&(e=e.href),e.startsWith("http://")||e.startsWith("https://")?e:e.startsWith("//")?window.location.protocol+e:e.startsWith("/")?window.location.origin+e:new URL(e,window.location.href).href}function C(e){if(!e)return null;if(typeof e=="string")return e;if(e instanceof FormData){const t={};for(const[n,o]of e.entries())t[n]=o;return JSON.stringify(t)}if(e instanceof URLSearchParams)return e.toString();if(e instanceof ArrayBuffer||e instanceof Uint8Array)return"[Binary Data]";if(e instanceof Blob)return"[Blob Data]";try{return JSON.stringify(e)}catch{return String(e)}}function A(){new MutationObserver(function(t){t.forEach(function(n){n.addedNodes.forEach(function(o){if(o.nodeType===Node.ELEMENT_NODE){const r=o;r.textContent&&r.textContent.includes("query")&&(r.textContent.includes("{")||r.textContent.includes("mutation"))&&i("API_TESTER_GRAPHQL_DETECTED",{query:r.textContent,element:r.tagName,timestamp:Date.now()})}})})}).observe(document.body,{childList:!0,subtree:!0,characterData:!0})}function b(){const e=console.log,t=console.error,n=console.warn;console.log=function(...o){return T("log",o),e.apply(console,o)},console.error=function(...o){return T("error",o),t.apply(console,o)},console.warn=function(...o){return T("warn",o),n.apply(console,o)}}function T(e,t){const n=t.join(" ").toLowerCase();(n.includes("api")||n.includes("xhr")||n.includes("fetch")||n.includes("http")||n.includes("request"))&&i("API_TESTER_CONSOLE_LOG",{level:e,message:t.join(" "),timestamp:Date.now()})}function L(){if("PerformanceObserver"in window){const e=new PerformanceObserver(function(t){t.getEntries().forEach(function(n){if(n.entryType==="navigation"||n.entryType==="resource"){const o=n;(n.name.includes("api")||n.name.includes("/v1/")||n.name.includes("/v2/")||n.name.endsWith(".json"))&&i("API_TESTER_PERFORMANCE",{name:n.name,type:n.entryType,duration:n.duration,size:o.transferSize,timestamp:n.startTime})}})});try{e.observe({entryTypes:["navigation","resource"]})}catch(t){console.warn("Performance monitoring not supported:",t)}}}function D(){const e=Object.getOwnPropertyDescriptor(Document.prototype,"cookie")||Object.getOwnPropertyDescriptor(HTMLDocument.prototype,"cookie");e&&e.get&&e.set&&Object.defineProperty(document,"cookie",{get:function(){return e.get.call(document)},set:function(t){return i("API_TESTER_COOKIE_SET",{cookie:t,timestamp:Date.now()}),e.set.call(document,t)}})}function N(){const e=Storage.prototype.setItem,t=Storage.prototype.removeItem,n=Storage.prototype.clear;Storage.prototype.setItem=function(o,r){return i("API_TESTER_STORAGE_SET",{type:this===localStorage?"localStorage":"sessionStorage",key:o,value:r,timestamp:Date.now()}),e.call(this,o,r)},Storage.prototype.removeItem=function(o){return i("API_TESTER_STORAGE_REMOVE",{type:this===localStorage?"localStorage":"sessionStorage",key:o,timestamp:Date.now()}),t.call(this,o)},Storage.prototype.clear=function(){return i("API_TESTER_STORAGE_CLEAR",{type:this===localStorage?"localStorage":"sessionStorage",timestamp:Date.now()}),n.call(this)}}function m(){c.interceptFetch&&_(),c.interceptXHR&&w(),P(),A(),b(),L(),D(),N(),i("API_TESTER_INITIALIZED",{url:window.location.href,timestamp:Date.now(),userAgent:navigator.userAgent})}window.apiTester={getConfig:()=>c,setConfig:e=>{c={...c,...e},i("API_TESTER_CONFIG_CHANGED",c)},getPendingRequests:()=>Array.from(l.values()),clearPendingRequests:()=>l.clear(),testRequest:function(e,t={}){return fetch(e,t)}},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m(),console.log("API Tester injected script initialized")})();
